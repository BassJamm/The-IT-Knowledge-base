[{"title":"Restore VM from Snapshot","type":0,"sectionRef":"#","url":"/Azure/Data Management/Restore VM from Snapshot","content":"","keywords":"IT  KnowledgeBase  Microsoft  Azure  Computers"},{"title":"Step 1: Create a new Managed Disk​","type":1,"pageTitle":"Restore VM from Snapshot","url":"/Azure/Data Management/Restore VM from Snapshot#step-1-create-a-new-managed-disk","content":"Firstly we need to create a new managed disk from the snapshot taken, this is to then replace the disk on the VM we need to restore. In the search box, enter Disks, and then select Disks from the list.On the Disks page, select Create.Create the new disk based off of the current disk of the VM (In Source type, ensure the Snapshot is selected). "},{"title":"Step 2: Attach the new disk​","type":1,"pageTitle":"Restore VM from Snapshot","url":"/Azure/Data Management/Restore VM from Snapshot#step-2-attach-the-new-disk","content":"caution Confirm there's no public IP attached to this VM, this process will stop &amp; De-Allocate the VM in question. Find your VM in the Azure Portal.Select Disks.Click Swap OS Disk. "},{"title":"Step 3: Test the VM​","type":1,"pageTitle":"Restore VM from Snapshot","url":"/Azure/Data Management/Restore VM from Snapshot#step-3-test-the-vm","content":"Once you've attached the new disk. Check it boots correctly.Confirm apps are installed and run "},{"title":"Decommission and AAD App","type":0,"sectionRef":"#","url":"/Azure Active Directory/App Registrations/Decom and AAD App","content":"","keywords":"IT  KnowledgeBase  Microsoft  Azure  Computers"},{"title":"Document Control​","type":1,"pageTitle":"Decommission and AAD App","url":"/Azure Active Directory/App Registrations/Decom and AAD App#document-control","content":"Created: 27/04/23Last Updated: 27/04/23 "},{"title":"Prerequisites​","type":1,"pageTitle":"Decommission and AAD App","url":"/Azure Active Directory/App Registrations/Decom and AAD App#prerequisites","content":"Must be an owner of the application or have admin privileges. "},{"title":"Locate the App​","type":1,"pageTitle":"Decommission and AAD App","url":"/Azure Active Directory/App Registrations/Decom and AAD App#locate-the-app","content":"Sign in to the Azure portal.Search and select the Azure Active Directory app.Under Manage, select App registrations and select the application(Desktop Portal) that you want to configure. "},{"title":"Confirm the App is not longer used​","type":1,"pageTitle":"Decommission and AAD App","url":"/Azure Active Directory/App Registrations/Decom and AAD App#confirm-the-app-is-not-longer-used","content":"Prevent access via the app to determine it is not being used, change the following Application settings using the Azure AD portal. Overview Page Enabled for users to sign-in? - Set this setting to NO. With this off, the application cannot be used. Users and Groups Page Remove all groups\\users (Screenshot them incase they need to be re-added). Permissions Page Remove all Admin and User consented permissions (Screenshot them incase they need to be re-added). "},{"title":"Delete the App from Azure AD​","type":1,"pageTitle":"Decommission and AAD App","url":"/Azure Active Directory/App Registrations/Decom and AAD App#delete-the-app-from-azure-ad","content":"From the Overview page, select Delete.Read the deletion consequences. Check the box if one appears at the bottom of the pane.Select Delete to confirm that you want to delete the app. "},{"title":"Re-size a Virtual Machine","type":0,"sectionRef":"#","url":"/Azure/Infrastructure/Re-size a Virtual Machine","content":"","keywords":"IT  KnowledgeBase  Microsoft  Azure  Computers"},{"title":"Before you begin​","type":1,"pageTitle":"Re-size a Virtual Machine","url":"/Azure/Infrastructure/Re-size a Virtual Machine#before-you-begin","content":"Shutdown the VM from within it's OS if possible (Not always necessary at all but, nice to do).If you cannot see the VM size that you're looking for it may not be compatible with your VM. note You can have too many disk or NICs attached to the VM for the size you want. The type of disks that you have attached can limit your options, premium and standard tier. "},{"title":"Re-sizing the vm​","type":1,"pageTitle":"Re-size a Virtual Machine","url":"/Azure/Infrastructure/Re-size a Virtual Machine#re-sizing-the-vm","content":"De-allocating a VM can cause issues! De-allocating the VM also releases any dynamic IP addresses assigned to the VM. The OS and data disks are not affected. At the same time, you're releasing your ownership of the size of that VM. If you are resizing a production VM, consider using Azure Capacity Reservations to reserve Compute capacity in the region; otherwise you may have to pick another size. Open the Azure portal, https://portal.azure.com.Search for your virtual machine.In the left menu, Select Size.Choose the new size from the list of available sizes and then Select Resize. "},{"title":"Setup Azure Backup","type":0,"sectionRef":"#","url":"/Azure/Backup and Disaster Recovery/Setup Azure Backup","content":"","keywords":"IT  KnowledgeBase  Microsoft  Azure  Computers"},{"title":"Document Control​","type":1,"pageTitle":"Setup Azure Backup","url":"/Azure/Backup and Disaster Recovery/Setup Azure Backup#document-control","content":"Created: xLast Updated: 23/04/22 This document will run through a very basic Azure Backup setup scenario. caution This document is for setting backup policeis for Virutal Machines only. If you need to backup other resources, got to section 1.2, step 4 and select a differnet resource. "},{"title":"Create the below resources​","type":1,"pageTitle":"Setup Azure Backup","url":"/Azure/Backup and Disaster Recovery/Setup Azure Backup#create-the-below-resources","content":"info Use whatever naming conention fits in with what's being used already, I am just suggesting something here. Create the resource group, for example, rg-&lt;customername&gt;-&lt;region&gt;-&lt;prod/dev&gt;-backups-01.Create a recovery services vault to store the backups (GRS is the preferred option, LRS for lowest cost), for example, rsv-&lt;customername&gt;-&lt;region&gt;-&lt;prod/dev&gt;-backup-01.Create a log analytics workspace or reuse another one, for example, la-&lt;customername&gt;-&lt;region&gt;-&lt;prod/dev&gt;-backup-01. "},{"title":"Configure Backup Policy​","type":1,"pageTitle":"Setup Azure Backup","url":"/Azure/Backup and Disaster Recovery/Setup Azure Backup#configure-backup-policy","content":"Configure the backup policy in-line with whatever standard is being used already, my suggestions are below. In the Azure portal, select a Recovery Services vault to back up the VM.Under Backup, select Backup Policies.Click +Add.On Select policy type, select Azure Virtual Machine.On Create policy, perform the following actions: Policy sub type: StandardSuggested Name format: Bkup-policy-&lt;time of day&gt;-&lt;policy type&gt; (example name: bkup-policy-nightly-std).  "},{"title":"Configure Alerting​","type":1,"pageTitle":"Setup Azure Backup","url":"/Azure/Backup and Disaster Recovery/Setup Azure Backup#configure-alerting","content":"tip Note that this method is using the old backup alerting method, this is being replaced by Azure Monitor. Microsoft Link for more information Configure diagnostic logs to be sent from Azure Backup to the Log Anlytics workspace above. From the Recovery services vault just setup. Click on Backup Alerts, under the Monitoring section.Click Configure Notifications. Enable Notifications: YesRecipients(Email): monitoring@DomainName.comNotify: Hourly digestSeverity: Critical &amp; Warning Example of this below. "},{"title":"Configure Diagnostic log collection​","type":1,"pageTitle":"Setup Azure Backup","url":"/Azure/Backup and Disaster Recovery/Setup Azure Backup#configure-diagnostic-log-collection","content":"Configure diagnostic logs to be sent from Azure Backup to the Log Anlytics workspace above. Navigate to Diagnostic settings under Monitoring.Click Add Diagnostic Settings.Name your diagnostic setting, something informational, for example, &quot;AzBkup-Diagnostics&quot;, suggestion, Backup Report Data.Select Send to Log Analytics Workspace.Add a workspace and don't touch any other settings.Hit Save. tip Make sure to run the initial backup job from the Azure Backup Dashboard. "},{"title":"Restore data from a Snapshot","type":0,"sectionRef":"#","url":"/Azure/Data Management/Restore data from a Snapshot","content":"","keywords":"IT  KnowledgeBase  Microsoft  Azure  Computers"},{"title":"Document Control​","type":1,"pageTitle":"Restore data from a Snapshot","url":"/Azure/Data Management/Restore data from a Snapshot#document-control","content":"Created: xLast Updated: 23/04/22 info This doc is for file level restores, this differs from a VM level restore. "},{"title":"Create a new disk from a Snapshot​","type":1,"pageTitle":"Restore data from a Snapshot","url":"/Azure/Data Management/Restore data from a Snapshot#create-a-new-disk-from-a-snapshot","content":"Validate the Snapshot Make sure to check the SnapShot is valid before starting this process. I'm assuming that there's already a Snapshot ready to go. Open the Azure portal, https://portal.azure.com.Navigate to a VM that is available to have a disk attached to it.Click on Disks on the left-hand side.Create a new disk.Click Edit on the far right hand side. As shown in red above.Name your Disk, I'd suggest, snapshot_ServerName_Date_TimeSource, Select snapshot.Select the Snapshot you wish to attach.Make any changes to the Encryption Type.I'd suggest it not to be a shared disk.Press Save. This shouldn't take too long. "},{"title":"Error \"Host Caching is disabled...\"​","type":1,"pageTitle":"Restore data from a Snapshot","url":"/Azure/Data Management/Restore data from a Snapshot#error-host-caching-is-disabled","content":"If you see the error below, change the Host Caching option to &quot;none&quot;.  "},{"title":"Confirm disk is visibile in the OS​","type":1,"pageTitle":"Restore data from a Snapshot","url":"/Azure/Data Management/Restore data from a Snapshot#confirm-disk-is-visibile-in-the-os","content":"tip The share should be available from the get go however, you may need to bring the disk online within computer management. RDP into your VM &amp; check File Explorer for your disk, the name will be what the share was called originally.Open Computer Management, Click Disk Management.Right-Click on the disk, mark it as Oneline. You should now see it in File Explorer. "},{"title":"Detach the disk​","type":1,"pageTitle":"Restore data from a Snapshot","url":"/Azure/Data Management/Restore data from a Snapshot#detach-the-disk","content":"Close any open sessions to the disk that you attached.Navigate back to the VM in Azure Management Portal.Click the X button to the right-hand side of the disk. "},{"title":"Setup Azure Site Recovery","type":0,"sectionRef":"#","url":"/Azure/Backup and Disaster Recovery/Setup Azure Site Recovery","content":"","keywords":"IT  KnowledgeBase  Microsoft  Azure  Computers"},{"title":"Document Control​","type":1,"pageTitle":"Setup Azure Site Recovery","url":"/Azure/Backup and Disaster Recovery/Setup Azure Site Recovery#document-control","content":"Created: xLast Updated: 23/04/22 "},{"title":"Overview of tasks​","type":1,"pageTitle":"Setup Azure Site Recovery","url":"/Azure/Backup and Disaster Recovery/Setup Azure Site Recovery#overview-of-tasks","content":"Create Recovery Vault and Resource Group.Setup replication for the resources needing it.Confirm Network information of each VM.Allow the initial Synchronization to run.Setup a Recovery Plan.Run a Test Failover. "},{"title":"Decisions to make before beginning​","type":1,"pageTitle":"Setup Azure Site Recovery","url":"/Azure/Backup and Disaster Recovery/Setup Azure Site Recovery#decisions-to-make-before-beginning","content":"These are expanded upon throughout the guide, click the options below to jump to that section. Naming Conventions.Regions to be used.Networking (Create them manually or let ASR do this for you.)Regional vCPU and VM Series Quotas. "},{"title":"Naming Conventions​","type":1,"pageTitle":"Setup Azure Site Recovery","url":"/Azure/Backup and Disaster Recovery/Setup Azure Site Recovery#naming-conventions","content":"The resources cannot be renamed after they've been created, decide ahead of time what your naming convention will be, examples are below. Recover Services Vault – Customer or Domain Name – region – abbreviation of resource ( rsv-cuss-eus-asr )Resource Group – Customer or Domain Name – region – abbreviation of resource ( rg-cust-eus-asr ) "},{"title":"Regions​","type":1,"pageTitle":"Setup Azure Site Recovery","url":"/Azure/Backup and Disaster Recovery/Setup Azure Site Recovery#regions","content":"Some Azure services rely upon regional pairs by default, such as Azure redundant storage; review this Microsoft document for the pairs for consideration. For example, the primary region for you maybe UK South(London), this region is paired with UK West(Cardiff). "},{"title":"Networking​","type":1,"pageTitle":"Setup Azure Site Recovery","url":"/Azure/Backup and Disaster Recovery/Setup Azure Site Recovery#networking","content":"VNETs​ When you initially setup a VM replica, the ASR wizard can create the VNETs and all subnets within that vnet automatically. You don't have to use the wizard though, and you can pre-create the replica vnets and subnets via the Azure Portal or PowerShell. Creating your own VNETs The added bonus of doing this yourself means you can create your own naming convention, by default, ASR will setup the VNET with the same name but with the -asr appended to the end of it. Network Security Groups​ NSGs (Network Security Groups) are not automatically replicated over through ASR, you'll have to recreate these yourself. You can use a script to export the rules from them, you can them &quot;import&quot; the rules back into your newly created ones. Public IPs​ These also have to be pre-configured and possibly re-assigned after the VMs have been failed over. "},{"title":"Regional vCPU and VM Series Quotas​","type":1,"pageTitle":"Setup Azure Site Recovery","url":"/Azure/Backup and Disaster Recovery/Setup Azure Site Recovery#regional-vcpu-and-vm-series-quotas","content":"A common issue with replication can be restricted quota limits for VM sizes in other Azure regions. The VM family vCPU quotas often need to be increased prior to replication. The replication process will start but will give an error regarding vCPU quotas and eventually fail. Request a quota increase To request a CPU quota increase - Quotas -&gt; Compute -&gt; Filter to the region UK West -&gt; Select VM family size and click the pencil edit button on the right. Then request increase. "},{"title":"Setup Guidance​","type":1,"pageTitle":"Setup Azure Site Recovery","url":"/Azure/Backup and Disaster Recovery/Setup Azure Site Recovery#setup-guidance","content":""},{"title":"Create Recovery Vault and Resource Group​","type":1,"pageTitle":"Setup Azure Site Recovery","url":"/Azure/Backup and Disaster Recovery/Setup Azure Site Recovery#create-recovery-vault-and-resource-group","content":"Resource Regions Make sure to setup the Resource Group and the Recovery Service Vault in the region you want to replicate the resources too or your secondary region. Login to the Azure Portal, https://portal.azure.com.Search for Recovery Service Vaults.Create the new resources. Create a new Resource Group, using the naming convention mentioned in this section.Create a new Recovery Service Vault, using the naming convention mentioned in this section.Select the Region that matches the pairings in this Microsoft document. That's the resources setup. "},{"title":"Add Resources for ASR​","type":1,"pageTitle":"Setup Azure Site Recovery","url":"/Azure/Backup and Disaster Recovery/Setup Azure Site Recovery#add-resources-for-asr","content":"Step 5, Selecting your Source Information If this option does not populate with anything or, you don't see what you think you should, you may have to back out and start over. It seems to be a bit 'buggy' in my experience. Also make sure your source region is correct otherwise you'll see nothing. Navigate to your new Recovery Services Vault.Find and select Replicated Items from the list on the left.Click + Replicate.Select Azure virtual machines. Select the source information for where the resource is sitting already. Region: This should be your original or source regionSubscription: Select the Subscription where your resources are currently.Resource Group: Select the Resource Group where your resources are currently.Virtual machine deployment model: Resource Manager.Disaster recovery between availability zones?: It's greyed out for me, I'm assuming you're not using that! Press Next.Select your VMs from the list.Press Next.Select the Target location information. (The term new and -asr, is appended to any resource created here.)Make sure to select the correct subnet, Azure will default to the first subnet in the VNET. Check the dropdown menu to ensure the vnet hasn’t been created previously, sometimes this option does not populate correctly. Click View/edit storage configuration to check the destination disk type is Standard HDD. Click Replica Managed Disk and select Standard HDD to reduce ASR costs. Save and Press Next to get to the Manage tab.For Extension Settings, select Allow ASR to manage. The wizard will attempt to create an automation account which automatically updates the ASR agents. If it should fail, it will not stop this from succeeding, check here for more info. Click Enable Replication. This process can take 10 - 15 minutes to complete however, the initial synchronization of the VMs over to the secondary region will take considerably longer, perhaps to run over night. "},{"title":"Check Failover Health​","type":1,"pageTitle":"Setup Azure Site Recovery","url":"/Azure/Backup and Disaster Recovery/Setup Azure Site Recovery#check-failover-health","content":"Navigate to your new Recovery Services Vault.Find and select Replicated Items from the list on the left. Within this window you'll see the replicated resources and the Failover Health. "},{"title":"Set the Network info for replicated items​","type":1,"pageTitle":"Setup Azure Site Recovery","url":"/Azure/Backup and Disaster Recovery/Setup Azure Site Recovery#set-the-network-info-for-replicated-items","content":"info You can only complete this step once the initial sync has completed. To confirm this, you can check the status of the items using the instructions in the section above here. Each VM you're replicating needs to have the networking information confirmed on them for the replicated region. Navigate to a VM that's been setup for ASR.Find Disaster Recovery on the left hand side and select this.Click Network on the left hand side.Select Edit.Find the section labelled, Primary IP Configuration. Make sure to set the make sure to confirm Private IP address and the Public IP address if needed. "},{"title":"Setup Recovery Plan​","type":1,"pageTitle":"Setup Azure Site Recovery","url":"/Azure/Backup and Disaster Recovery/Setup Azure Site Recovery#setup-recovery-plan","content":"The recovery plan allows you to perform a failover or failover test with multiple machines. Navigate to your Recovery Services vault.Select Recovery Plans (Site Recovery).Click +Recovery Plan.In Create recovery plan, specify a name for the plan.Choose a source and target based on the machines in the plan, and select Resource Manager for the deployment model. The source location must have machines that are enabled for failover and recovery. "},{"title":"Running a Test Failover​","type":1,"pageTitle":"Setup Azure Site Recovery","url":"/Azure/Backup and Disaster Recovery/Setup Azure Site Recovery#running-a-test-failover","content":"Test Failover will create the VM resources in the secondary region without shutting down or impacting the production resources in your primary region. You'll see duplicate VMs with -test appended to the end of them. "},{"title":"Start the test​","type":1,"pageTitle":"Setup Azure Site Recovery","url":"/Azure/Backup and Disaster Recovery/Setup Azure Site Recovery#start-the-test","content":"Navigate to your Recovery Services vault.Select Recovery Plans (Site Recovery).Click on the relevant Recovery Plan.Click Test Failover.Choose the recovery point and the VNET target.Click OK. Whilst the test is running, you can select the running job in the Notifications menu, it will show you the progress within the Recovery Plan. Once the plan completes you'll see the duplicate resources in your Azure Portal, they'll have the -test at the end of their names.  "},{"title":"End the Test & Cleanup Resources​","type":1,"pageTitle":"Setup Azure Site Recovery","url":"/Azure/Backup and Disaster Recovery/Setup Azure Site Recovery#end-the-test--cleanup-resources","content":"Step 4 below You can click on the Recovery Plan name and go into it to end the test, you can do this if you wish to view more information about the test. Navigate to your Recovery Services vault.Select Recovery Plans (Site Recovery).Find the Recovery Plan you just initiated.Select the 3 dots on the right hand side.Click Cleanup test failover.Add any Notes for the test.Tick the box for Testing is complete. Delete test failover virtual machine(s).Click OK. info Once you click OK you will be stuck on the page until the task completes, I would suggest not exiting the page until it is finished. Again you can watch the operation complete from the Notifications menu. "},{"title":"Issues​","type":1,"pageTitle":"Setup Azure Site Recovery","url":"/Azure/Backup and Disaster Recovery/Setup Azure Site Recovery#issues","content":""},{"title":"Automation Accounts error​","type":1,"pageTitle":"Setup Azure Site Recovery","url":"/Azure/Backup and Disaster Recovery/Setup Azure Site Recovery#automation-accounts-error","content":"If the ASR automation account fails to create, which is often the case, you can fix this by forcing creation within the Recovery Service Vault page. From the Recovery Services vault.Click Site Recovery Infrastructure.Click Extension Update Settings.Select Allow Site Recovery to manage.Select On.Click Save. This will attempt to fix the automation account. "},{"title":"Stale resource links on the VM​","type":1,"pageTitle":"Setup Azure Site Recovery","url":"/Azure/Backup and Disaster Recovery/Setup Azure Site Recovery#stale-resource-links-on-the-vm","content":"Full Error: - The cleanup of the stale ASR resource links on the VM failed due to one of the below reasons. The resource or the resource group has 'Delete' locks or 'ReadOnly' locks and deletion of resource links failed. Azure error messages: Azure status code: Conflict. Arm error code: ScopeLocked. Replication not enabled on VM with stale resources (error code 150226) | Microsoft doc link  Make sure to remove any delete locks on resources before you remove the resource from replication protection, otherwise you'll end up with issues noted in the above link. "},{"title":"Generating a CSR","type":0,"sectionRef":"#","url":"/Certificates/Generating a CSR","content":"","keywords":"IT  KnowledgeBase  Microsoft  Azure  Computers"},{"title":"Document Control​","type":1,"pageTitle":"Generating a CSR","url":"/Certificates/Generating a CSR#document-control","content":"Created: 27/04/23Last Updated: 27/04/23 "},{"title":"What is a CSR?​","type":1,"pageTitle":"Generating a CSR","url":"/Certificates/Generating a CSR#what-is-a-csr","content":"what does it stand for? CSR stands for Certificate signing request. The CSR contains information (e.g. common name, organization, country) the Certificate Authority (CA) will use to create your certificate. It also contains the public key that will be included in your certificate and is signed with the corresponding private key. "},{"title":"Creatine one (Windows IIS)​","type":1,"pageTitle":"Generating a CSR","url":"/Certificates/Generating a CSR#creatine-one-windows-iis","content":"The most common method of generating or creating a CSR is via Internet Information Services (IIS), which is a microsoft product that runs on the Windows OS as part of a server installation. What other methods are there? There are lots of different methods to generate a CSR file, it depends on what operation system you're running. Try this link for more information. RDP or Login to a machine running IIS.Search for IIS in the start menu to find the app and open it.Click the Server Name.From the center menu double-click Server Certificates in the Security section.Select the Actions menu from the right. Click Create Certificate Request.The Request Certificate Wizard will appear. In the Distinguished Name Properties window enter information as prompted. Click Next. Mandatory information You must fill the Common Name in with the domain that you wish to cover with the certificate. If you wanted to create a certificate for &quot;www.finepies.com&quot;, that is what must be in the Common Name field. In the Cryptographic Service Provider Properties window leave the top field as Microsoft RSA SChannel Cryptographic Provider. Make sure the minimum Bit length is set ot 2048 or higher.Click Next.Save the text file someone easy to find and you're done. Take the CSR file to your certificate authority, internal or externally hosted and upload your CSR, you'll get a certificate back again. "},{"title":"Final steps​","type":1,"pageTitle":"Generating a CSR","url":"/Certificates/Generating a CSR#final-steps","content":"Depending on what you want to use the certificate for, you may need to &quot;complete&quot; the certificate. Access IIS again.From the center menu double-click Server Certificates in the Security section.Click Complete Certificate Request.Complete the Wizard and it will have imported the certificate into the store you selected. You'll now be able to export the certificate and the private key should you need to. "},{"title":"Updating an image (Citrix Cloud)","type":0,"sectionRef":"#","url":"/Citrix/Updating an image","content":"","keywords":"IT  KnowledgeBase  Microsoft  Azure  Computers"},{"title":"Document Control​","type":1,"pageTitle":"Updating an image (Citrix Cloud)","url":"/Citrix/Updating an image#document-control","content":"Created: 27/04/23Last Updated: 27/04/23 "},{"title":"Before you begin​","type":1,"pageTitle":"Updating an image (Citrix Cloud)","url":"/Citrix/Updating an image#before-you-begin","content":"Gather up the updates that are needed to be applied to the Citrix image including: - Required Windows Security and Feature updates.Application Updates and changes.OS changes (That are not deploying via policy) Once you have your updates, liaise with your team or IT contact to arrange a change window with them, as the customer will want to test the update themselves first before they're rolled out to production. Change Window A good rule of thumb that's done me well, is to complete an image update over a 2 week period. The 1st week for rolling it out the test environment &amp; the 2nd week would be to deploy to the production environment. "},{"title":"Deploy changes to the test environment​","type":1,"pageTitle":"Updating an image (Citrix Cloud)","url":"/Citrix/Updating an image#deploy-changes-to-the-test-environment","content":"Locate the production template VM. "},{"title":"Snapshot the VM​","type":1,"pageTitle":"Updating an image (Citrix Cloud)","url":"/Citrix/Updating an image#snapshot-the-vm","content":"Locate the VM resource; search for it or follow the image below.Click Disks.Select the OS disk.Create Snapshot.Name the Snapshot appropriately, &quot;VMName-Before-&quot;insert update description here&quot;-dd-mm-yyyy-hh-hh&quot;. "},{"title":"Make any changes to the VM​","type":1,"pageTitle":"Updating an image (Citrix Cloud)","url":"/Citrix/Updating an image#make-any-changes-to-the-vm","content":"You should now remote into the VM and make any changes that you need to.Follow steps from the above section to take another Snapshot.Name it appropriately, &quot;VMName-prod-After-&quot;insert update description here&quot;-dd-mm-yyyy-hh-hh&quot;.Power off the template VM, you no longer need it running. "},{"title":"Update the test Citrix Image​","type":1,"pageTitle":"Updating an image (Citrix Cloud)","url":"/Citrix/Updating an image#update-the-test-citrix-image","content":"Access Citrix Cloud, https://citrix.cloud.com/.Click Manage under &quot;DaaS Standard for Azure&quot;.Select Manage in the top left and click Full Configuration.Select Machine Catalogs.Select the testing Catalogue, named &quot;Your Catalogue Name&quot;.Above the list of Catalogues,select Change Master Image.Click Next on the wizard to step 2.Select an image from the options available. (It points to the resource group where the template VM resides).Add a note under this to describe the updates that have been made. Make the note descriptive to explain what has been changed.Select the minimum functional level as required.Press Next.Leave the roll out strategy as On next shutdown unless you need to change this.Complete the wizard to complete this process. "},{"title":"Deploy changes to the production environment​","type":1,"pageTitle":"Updating an image (Citrix Cloud)","url":"/Citrix/Updating an image#deploy-changes-to-the-production-environment","content":""},{"title":"Update the master Image​","type":1,"pageTitle":"Updating an image (Citrix Cloud)","url":"/Citrix/Updating an image#update-the-master-image","content":"Access Citrix Cloud, https://citrix.cloud.com/ and then follow the steps from the section above this, to update the master image of your production Machine Catalog. "},{"title":"Exchange Online","type":0,"sectionRef":"#","url":"/Command Line References/Exchange Online","content":"","keywords":"IT  KnowledgeBase  Microsoft  Azure  Computers"},{"title":"Document Control​","type":1,"pageTitle":"Exchange Online","url":"/Command Line References/Exchange Online#document-control","content":"Created: 23/04/22Last Updated: 23/04/22 "},{"title":"Module Install and Management​","type":1,"pageTitle":"Exchange Online","url":"/Command Line References/Exchange Online#module-install-and-management","content":"Install-module -Name ExchangeOnline Update-Module - Name ExchagneOnline  "},{"title":"Manage Calendar Permissions​","type":1,"pageTitle":"Exchange Online","url":"/Command Line References/Exchange Online#manage-calendar-permissions","content":""},{"title":"Get Calendar Permissions​","type":1,"pageTitle":"Exchange Online","url":"/Command Line References/Exchange Online#get-calendar-permissions","content":"Get-MailboxFolderPermission $userObject = Get-Mailbox -RecipientTypeDetails UserMailbox | select UserPrincipalName # Single mailbox command. # Get-MailboxFolderPermission -Identity Ryan.Wilson@traderemedies.gov.uk:\\Calendar -User Default | ft # Loop through each user and get calendar permissions of the default user. foreach($user in $userObject){ $calendar = $user.UserPrincipalName+&quot;:\\Calendar&quot; Get-MailboxFolderPermission -Identity $calendar | Export-csv -Append $env:USERPROFILE\\Downloads\\calendar-perms.csv }  "},{"title":"Set Calendar Permissions​","type":1,"pageTitle":"Exchange Online","url":"/Command Line References/Exchange Online#set-calendar-permissions","content":"Set-MailboxFolderPermission $userObject = Get-Mailbox -RecipientTypeDetails UserMailbox | select UserPrincipalName # Single mailbox command. # Set-MailboxFolderPermission -Identity firstname.Lastname@fordway.com:\\Calendar -User Default -AccessRights LimitedDetails # Loop through each user and set calendar permissions of the default user. foreach($user in $userObject){ $calendar = $user.UserPrincipalName+&quot;:\\Calendar&quot; Set-MailboxFolderPermission -Identity $calendar -User Default -AccessRights LimitedDetails  "},{"title":"Request from Internal CA","type":0,"sectionRef":"#","url":"/Certificates/Request from Internal CA","content":"","keywords":"IT  KnowledgeBase  Microsoft  Azure  Computers"},{"title":"Document Control​","type":1,"pageTitle":"Request from Internal CA","url":"/Certificates/Request from Internal CA#document-control","content":"Created: 27/04/23Last Updated: 27/04/23 "},{"title":"Generating a CSR​","type":1,"pageTitle":"Request from Internal CA","url":"/Certificates/Request from Internal CA#generating-a-csr","content":"Generate a CSR from another server, doing this from IIS is a tried and tested method. To see how to do this, there's a reference guide here, Generating a CSR. "},{"title":"Submitting the request to the CA​","type":1,"pageTitle":"Request from Internal CA","url":"/Certificates/Request from Internal CA#submitting-the-request-to-the-ca","content":"Open a web browser.Browse to your Certificate Authority website. Certificate Authority website URL Enter the address of your CA followed by /certsrv for example http://ca server name/certsrv in the Address bar. Click Request a certificate Click submit an advanced certificate request. Paste in the CSR. Certificate template Make sure to change the template you want to use if that is applicable. Click submit. "},{"title":"Completing the Request​","type":1,"pageTitle":"Request from Internal CA","url":"/Certificates/Request from Internal CA#completing-the-request","content":"Your certificate should be approved almost instantly and some download options will appear. Select whatever download option is best for you; I'd suggest renaming the certificate file you download, it'll have a generic name otherwise.  tip The chain option downloads the Certificate Authority certs (Root and Sub-CAs in the chain) as well, all the way back to the root ca. "},{"title":"Create an Automation Account","type":0,"sectionRef":"#","url":"/Azure/Infrastructure/Create an Automation Account","content":"","keywords":"IT  KnowledgeBase  Microsoft  Azure  Computers"},{"title":"Document Control​","type":1,"pageTitle":"Create an Automation Account","url":"/Azure/Infrastructure/Create an Automation Account#document-control","content":"Created: xLast Updated: 23/04/22 "},{"title":"Outline​","type":1,"pageTitle":"Create an Automation Account","url":"/Azure/Infrastructure/Create an Automation Account#outline","content":"Run As accounts deprecation Run As accounts are being deprecated, managed identities are replacing this. Setup the Resource Group and Automation Account.Setup the Identity for the Automation Account, this is key to running scripts gainst Azure Active Directoy and Office 365 resources. Create ourselves a Runbook, that sits inside the Automation Account. Install the relevant modules for the code we want to run.Write ourselves a little script. Setup a schedule for the Runbook. "},{"title":"Setup the Resource Group and Automation Account.​","type":1,"pageTitle":"Create an Automation Account","url":"/Azure/Infrastructure/Create an Automation Account#setup-the-resource-group-and-automation-account","content":"Navigate to the Azure portal.Search for Automation Account in the search bar.Select the Automation Account option, Click create in the middle of the screen or Click +Add in the top left.Fill in the necessary information. Resource Group Name (Create one if needs be).Name.Region caution Make sure you Select the same region as the resources you want to query, if the account is to query something else, like Azure AD or Office 365, the region is not so important. Select the Advanced tab and Select the best option for you. System assigned, is attached to the automation account it lives and dies with the automation account resource.User assigned, is one you setup yourself in Azure AD and can be used by multiple resources and is completely seperate to your automation account. Click Review + Create to setup the resource. tip You'll need to assign Azure ADroles and App Permissions to the System or User managed Identity, Microsoft have decided not to make this easy and it needs to be done via command line. "},{"title":"Apply permissions to Managed(System assigned) Identity​","type":1,"pageTitle":"Create an Automation Account","url":"/Azure/Infrastructure/Create an Automation Account#apply-permissions-to-managedsystem-assigned-identity","content":"You'll need to apply the permissions to the Managed Identity using PowerShell unfortunatly, a Microsoft seem to have decided to make this difficult for us! Reference for where this came fromMicrosoft reference for command. Role names You'll need to find the correct role\\permission name that you want to assign using the script below. Try this Microsoft doc for the Microosft Graph API permissions. "},{"title":"The command​","type":1,"pageTitle":"Create an Automation Account","url":"/Azure/Infrastructure/Create an Automation Account#the-command","content":"The below is a script you can run but, you can run it line by line to see what is going on if that's more comfortable. The general gist is that you are applying the permissions from the Microsoft Graph App to your Managed Identity. tip This same idea works for any of the Microsoft applications, each serivce has an application that is registered in your tenant. You can apply roles from any of them in theory.  # Your tenant id. $TenantID=&quot;Add your tenant ID&quot; # Microsoft Graph App ID (DON'T CHANGE). $GraphAppId = &quot;00000003-0000-0000-c000-000000000000&quot; # Name of the manage identity (same as the Logic App name). $DisplayNameOfMSI=&quot;Add display name of Enterprise App&quot; # Check the Microsoft Graph documentation for the permission you need for the operation. $PermissionName = &quot;Add your permission here&quot; # Install the module (You need admin on the machine) Install-Module AzureAD # Connect to Azure AD via tenant ID, you'll need an admin account to login with though. Connect-AzureAD -TenantId $TenantID # Collects the Target System Managed Identities information into the MSI variable. $MSI = (Get-AzureADServicePrincipal -Filter &quot;displayName eq '$DisplayNameOfMSI'&quot;) Start-Sleep -Seconds 10 # Store the Microsoft Graph API informaiton into the GraphServicePrincipal variable. $GraphServicePrincipal = Get-AzureADServicePrincipal -Filter &quot;appId eq '$GraphAppId'&quot; # Searches Microsoft Graph API for the value matching the PermissionName variable populated above and stores this in the AppRole Variable. $AppRole = $GraphServicePrincipal.AppRoles | Where-Object {$_.Value -eq $PermissionName -and $_.AllowedMemberTypes -contains &quot;Application&quot;} # Assigned the permission from the Microsoft Graph API to the target Managed Identity. New-AzureADServiceAppRoleAssignment -ObjectId $MSI.ObjectId -ResourceId $GraphServicePrincipal.ObjectId -Id $appRole.Id -PrincipalId $MSI.ObjectId  Annotated the hell out of it as the command really confused me. Heads up! It takes a few minutes for this change to show in the GUI.If the permission already exists the prompt will error on the final command. "},{"title":"Setup Automation Runbook​","type":1,"pageTitle":"Create an Automation Account","url":"/Azure/Infrastructure/Create an Automation Account#setup-automation-runbook","content":"Sign in to the Azure portal.Search for and Select Automation Accounts.On the Automation Accounts page, Select your Automation account from the list.From the Automation account, Select Runbooks under Process Automation to open the list of runbooks.Click Create a runbook and fill in the information below. Name .Select its type.Select the Runtime versionEnter applicable Description Click Create to create the runbook. "},{"title":"Install any Modules​","type":1,"pageTitle":"Create an Automation Account","url":"/Azure/Infrastructure/Create an Automation Account#install-any-modules","content":"Sign in to the Azure portal.Search for and Select Automation Accounts.On the Automation Accounts page, Select your Automation account from the list.From the Automation account, Select Modules under Shared Resources. In here you can see a list of currently installed modules and you can add more by Clicking on the +Add a module button. tip You may find that you have to search around a bit for the module that you do actually want and when you do find the module you want, search for the command that you want to use, sometimes the module name is right but the command is missing! Microsoft Graph is probably the most well rounded module but, it's quite finicky to use, otherwise stick with the Az Command line. "},{"title":"Test Script​","type":1,"pageTitle":"Create an Automation Account","url":"/Azure/Infrastructure/Create an Automation Account#test-script","content":""},{"title":"Create the Script​","type":1,"pageTitle":"Create an Automation Account","url":"/Azure/Infrastructure/Create an Automation Account#create-the-script","content":"Navigate to your runbook.Click Edit at the top.Here you can enter your script. Useful options on the left hand side to note: CMDLETS, which you can use to find commands from the installed modules.ASSETS, which will show you the various resources available to your runbooks which are saved within your automation account resource. "},{"title":"Test Script​","type":1,"pageTitle":"Create an Automation Account","url":"/Azure/Infrastructure/Create an Automation Account#test-script-1","content":"Once your done and ready to test. Click on Test pane at the top.Click Start in the top left to being running the scrpt. I found it really hard to get my head around how this works for some reason. So expect that this may take quite a few tries to get right. Storage Account Key Before you can use the script as a base, you'll need to store the storage account key as a variable in your Automation account. Open your Automation Account.Click on Variables under Shared Resources.Click Add a variable.Create a new string variable. See the script for how to reference these in your runbooks. # Ensures you do not inherit an AzContext in your runbook Disable-AzContextAutosave -Scope Process | Out-Null #Storage Account Information $StorageACCKey = Get-AutomationVariable -Name 'stgacckey01' $ContainerName = &quot;Enter the blob container name&quot; # Connect using a Managed Service Identity try { Connect-AzAccount -Identity } catch{ Write-Output &quot;Unable to login. Aborting.&quot;; exit } $Users = Get-AzADUser | Select-Object DisplayName, Id, Mail, UserPrincipalName Write-Output $Users # Exports the data in the $Users variable into a local environmental variable that will store the information whilst running in the Automation account. $Users | Export-Csv &quot;$Env:temp\\Users.csv&quot; -notypeinformation # Creates a new context to enable connection to the storage account. $Context = New-AzureStorageContext -StorageAccountName &quot;whautomationfiledump&quot; -StorageAccountKey $StorageACCKey # This copes the csv file in the $Env:temp/MFAState.csv variable and copies it to the blob. Set-AzureStorageBlobContent -Context $Context -Container $ContainerName -File &quot;$Env:temp\\Users.csv&quot; -Blob &quot;Users.csv&quot; -force  In my experience The test window is not like a command promtp and will not output the commands running or anything at all apart from really confusing errors. Try to build error catching into your script, use the try, catch commands to write the errors to the promtp for debugging. More in this in the testing section at the bottom. "},{"title":"Setup the Schedule​","type":1,"pageTitle":"Create an Automation Account","url":"/Azure/Infrastructure/Create an Automation Account#setup-the-schedule","content":"This has been mostly regurgitated from this Microsoft link here. From your Automation account, on the left-hand pane Select Schedules under Shared Resources.Select Add a schedule.Select whether the schedule runs once or on a reoccurring schedule by Selecting Once or Recurring. If you Select Once, specify a start time and then Select Create.If you Select Recurring, specify a start time. For Recur every, Select how often you want the runbook to repeat. Select by hour, day, week, or month. Press Create to complete. tip You must publish the runbook before you can assign the schedule to it. Head back to your Runbook.Select Link to schedule at the top.Click the option to Link a schedule to your runbook, Select the schedule you created from the list.Click OK to complete. Example schedule below  "},{"title":"Testing​","type":1,"pageTitle":"Create an Automation Account","url":"/Azure/Infrastructure/Create an Automation Account#testing","content":""},{"title":"Testing the script​","type":1,"pageTitle":"Create an Automation Account","url":"/Azure/Infrastructure/Create an Automation Account#testing-the-script","content":"Error handling​ The test pane window for the most part will not output useful errors or show you how the script is running. I'd suggest building error handling and status updates into your script if you wish during debugging, it will help immensely. An example of the try, catch command sytax is below. # Connect using a Managed Service Identity try { Connect-AzAccount -Identity } catch{ Write-Output &quot;Unable to login. Aborting.&quot;; exit }  I'd also suggest using write-output all over the place to confirm progress and variables etc. Shout out Shout out to the VS code module for Automation Accounts, it'll let you pull down the runbook contents and edit in VsCode and upload it again. Highly recommend using this. "},{"title":"Confirm the data export​","type":1,"pageTitle":"Create an Automation Account","url":"/Azure/Infrastructure/Create an Automation Account#confirm-the-data-export","content":"Navigate to your storage account.Click on the File shares or Containers option, wherever you saved your data to.Click into the share\\container, find your file and Click on the 3 dots to the right of it. Click View\\edit, it should display a basic output of the file. "},{"title":"Further notes​","type":1,"pageTitle":"Create an Automation Account","url":"/Azure/Infrastructure/Create an Automation Account#further-notes","content":"Run As accounts are being deprecated, this method is by far the easiest to use when trying to pull info from AzureAD and Office 365. "},{"title":"Setup Azure Lighthouse","type":0,"sectionRef":"#","url":"/Azure/Infrastructure/Setup Azure Lighthouse","content":"","keywords":"IT  KnowledgeBase  Microsoft  Azure  Computers"},{"title":"Document Control​","type":1,"pageTitle":"Setup Azure Lighthouse","url":"/Azure/Infrastructure/Setup Azure Lighthouse#document-control","content":"Created: xLast Updated: 23/04/22 "},{"title":"Prerequisites and Notes​","type":1,"pageTitle":"Setup Azure Lighthouse","url":"/Azure/Infrastructure/Setup Azure Lighthouse#prerequisites-and-notes","content":"caution This document covers creating a template manually and uploading to a customer directly. Not an Azure Marketplace offering. "},{"title":"Online Reading​","type":1,"pageTitle":"Setup Azure Lighthouse","url":"/Azure/Infrastructure/Setup Azure Lighthouse#online-reading","content":"Microsoft doc - What is Azure Lighthouse?.Microsoft doc - Onboard a customer to Azure Lighthouse. "},{"title":"Training​","type":1,"pageTitle":"Setup Azure Lighthouse","url":"/Azure/Infrastructure/Setup Azure Lighthouse#training","content":"From testing I found that many staff are over-whelmed or confused initially by the customer resources showing in their own managing tenant, consider setting up Lighthouse for your more technical staff first who can train the others.Consider keeping the permissions as simple as possible and only giving access to Lighthouse those who really need it. Subscription Filter. When you add a new customer via Lighthouse, you'll need to amend their subscription filter to show them. I'd highly recommend training staff to use the filter to work with one subscription or customer at a time, save making changes to the wrong client\\customer. "},{"title":"Permissions and Roles​","type":1,"pageTitle":"Setup Azure Lighthouse","url":"/Azure/Infrastructure/Setup Azure Lighthouse#permissions-and-roles","content":"Azure Roles. There are over 170 roles in Azure, that's a silly amount of trawl through to find the perfect combination to work with. Consider what you look after for your client\\customer and simplify it as much as possible, limiting access to the staff who really need it may be enough of a security control for you. If you're an MSP there are too many roles to consider, I'd suggest using at the minimum or two groups that assign the Contributor role and the Reader role separately. You can use this segregation to separate those who should look but not touch and those who need to administer and change.PIM elevation works to provide just-in-time access, you can setup an approval process for work.The Managed Services Registration assignment Delete Role, should be assigned so the managing tenant can remove their own Lighthouse delegation without asking the customer to do it.Contributor is the highest role you can assign through Lighthouse. "},{"title":"Azure Lighthouse Deployment​","type":1,"pageTitle":"Setup Azure Lighthouse","url":"/Azure/Infrastructure/Setup Azure Lighthouse#azure-lighthouse-deployment","content":"Despite what the documentation says, you can deploy one lighthouse offering to manage multiple subscriptions and resource groups.To have a valid ARM template\\offering you must have one permanently assigned role, such as Reader.Contributor is the highest role you can assign through Lighthouse. (Duplicated I know but, this is important!) "},{"title":"Setup Guidance and Information​","type":1,"pageTitle":"Setup Azure Lighthouse","url":"/Azure/Infrastructure/Setup Azure Lighthouse#setup-guidance-and-information","content":""},{"title":"Azure AD​","type":1,"pageTitle":"Setup Azure Lighthouse","url":"/Azure/Infrastructure/Setup Azure Lighthouse#azure-ad","content":"Create your groups in Azure AD, these groups will contain the staff members that will access to the customer\\client via Azure Lighthouse. I'd Suggest something like the below, the groups can be as granular as you like and as numerous as you like. Azure Lighthouse Contributor.Azure Lighthouse Reader. Role Assignment to staff business roles. I tried initially to setup groups for our finance team, so they'd be able to manage billing however, this didn't seem to work as I expected and required them to have access to the Azure tenant. We found that Partner Centre solved this issue. "},{"title":"Azure Lighthouse Offering​","type":1,"pageTitle":"Setup Azure Lighthouse","url":"/Azure/Infrastructure/Setup Azure Lighthouse#azure-lighthouse-offering","content":"ARM Template​ Below is an outline and suggestion for each relevant configurable options for the ARM template. On-boarding multiple Subscriptions or Resource Groups for one client\\customer. You can delegate multiple resource groups and subscriptions to the same delegation from the Service Providers dashboard\\blade in the customer tenant. The documentation for this may suggest otherwise but, it does work. Offering Name​ This will show in your customer tenant so make sure if reads &quot;nicely&quot;, I'd suggest something like the following. Managing Company Name Lighthouse Offering for Customer Name - Subscription or Resource Group Name. Swap out the relevant information above if you use this naming convention. Description(s)​ This is also customer facing, my suggestion is below. Managing Company Name managed services offer to administer support resources.Managing Company Name offer to work on and administer project resources for project or PO number. Delegation Scope(s)​ You've got two options, Subscription and Resource Group, fairly self explanatory however, you cannot change these after deployment so make sure you select the right one for your needs. Authorizations​ Principal type: GroupName: Select one of the noted groups in section above.Display Name: Do not edit. (Friendly name that shows in customer tenant, will default to the group name)Role: Assign the roles noted against the groups above.Access Type: Permanent. "},{"title":"ARM template Example​","type":1,"pageTitle":"Setup Azure Lighthouse","url":"/Azure/Infrastructure/Setup Azure Lighthouse#arm-template-example","content":"You can ignore the top few lines until you find mspOfferName, close to this you'll find your description field. Change the defaultValue: information, not the description: information. Confirming your scope. &quot;$schema&quot;: &quot;https://schema.management.azure.com/schemas/2019-08-01/subscriptionDeploymentTemplate.json#&quot;,, this line should say subscription or resource deployment template, depending on what you selected. Similar situation with the mspOfferDescription: as well.  &quot;mspOfferName&quot;: { &quot;type&quot;: &quot;string&quot;, &quot;metadata&quot;: { &quot;description&quot;: &quot;Specify a unique name for your offer&quot; }, &quot;defaultValue&quot;: &quot;My Company Lighthouse Contributor Offer for Customer Name - Subscription Name &quot; }, &quot;mspOfferDescription&quot;: { &quot;type&quot;: &quot;string&quot;, &quot;metadata&quot;: { &quot;description&quot;: &quot;Name of the Managed Service Provider offering&quot; }, &quot;defaultValue&quot;: &quot;My Company managed services offer to administer support resources.&quot; }  Locate the variables: section to define your group and the Azure role assignments. managedByTenantId&quot; - is your tenant or partner tenant ID.&quot;authorizations&quot;: - Are you Azure Roles assignments.&quot;principalId&quot; - Is your object in the managing tenant.&quot;roleDefinitionId&quot; - Is the Azure AD role you've assigned. In the case below, it's Contributor and the Managed Services Registration assignment Delete roles.&quot;principalIdDisplayName&quot; - Is your friendly Group name, this will show in your customer tenant, it does not need to match the group name in the managing tenant. You'll see some of the information repeated for each role you assign to the same object in the managing tenant. &quot;variables&quot;: { &quot;mspRegistrationName&quot;: &quot;[guid(parameters('mspOfferName'))]&quot;, &quot;mspAssignmentName&quot;: &quot;[guid(parameters('mspOfferName'))]&quot;, &quot;managedByTenantId&quot;: &quot;Your tenant ID&quot;, &quot;authorizations&quot;: [ { &quot;principalId&quot;: &quot;Your object in the managing tenant&quot;, &quot;roleDefinitionId&quot;: &quot;b24988ac-6180-42a0-ab88-20f7382dd24c&quot;, &quot;principalIdDisplayName&quot;: &quot;Lighthouse Contributor&quot; }, { &quot;principalId&quot;: &quot;Your object in the managing tenant&quot;, &quot;roleDefinitionId&quot;: &quot;91c1777a-f3dc-4fae-b103-61d183457e46&quot;, &quot;principalIdDisplayName&quot;: &quot;Lighthouse Contributor&quot; } ] },  You can edit the JSON template directly! You don't need to always duck back into Azure Lighthouse to create the templates, you can just edit the JSON files if you're comfortable doing so. "},{"title":"Using Lighthouse​","type":1,"pageTitle":"Setup Azure Lighthouse","url":"/Azure/Infrastructure/Setup Azure Lighthouse#using-lighthouse","content":"tip The methods below are 2 direct methods for accessing customers, you'll be able to see their resources in the portal as if they were your own without having to use the two methods below. "},{"title":"Via the Lighthouse blade​","type":1,"pageTitle":"Setup Azure Lighthouse","url":"/Azure/Infrastructure/Setup Azure Lighthouse#via-the-lighthouse-blade","content":"Open the Azure Management Portal.Search for Azure Lighthouse.Click on the Delegations option on the left-hand side, you may need to click manage my customers if you’ve no connections.You will then see your list of your customer’s subscriptions that you have access to. "},{"title":"Via the subscriptions blade​","type":1,"pageTitle":"Setup Azure Lighthouse","url":"/Azure/Infrastructure/Setup Azure Lighthouse#via-the-subscriptions-blade","content":"You'll need to show the customer in the subscription filter first though. Open the Azure Management Portal.Navigate to the Subscriptions blade.The list of subscriptions will also list the customer subscriptions you have access too. You won't see the the customer subscriptions straight away! You need to first enable this in the Subscription filter. In the Azure portal, Select the Directory + subscriptions or Settings icon in the top right of the page.In the Directories + subscriptions settings page, ensure that the Advanced filters toggle is turned off.In the Default subscription filter section, select the appropriate directory and subscription. info If you have been granted access to one or more resource groups, rather than to an entire subscription, select the subscription to which that resource group belongs. You'll then work in the context of that subscription, but will only be able to access the designated resource group(s). "},{"title":"Partner Earned Credit (PEC) using PAL​","type":1,"pageTitle":"Setup Azure Lighthouse","url":"/Azure/Infrastructure/Setup Azure Lighthouse#partner-earned-credit-pec-using-pal","content":"PAL - Partner Admin link PAL is how a partner can be recognized by Microsoft for their work in Azure on-behalf-of their customer. Microsoft doc - Associate your partner ID when you onboard new customers vai Lighthouse.Microsoft doc - Link a PartnerID with PAL or DPOR for PAL To do this via Lighthouse, in a nutshell. Create a service principal user account in your managing tenant.Using that service principal account, link to your Associated Partner ID in your managing tenant.Include at least one authorization which includes the service principal Account as a user with an Azure built-in role that is eligible for PEC. caution This role must be granted as a permanent assignment, not as a just-in-time eligible authorization, in order for PEC to apply. "},{"title":"Certificate formats and Converting formats","type":0,"sectionRef":"#","url":"/Certificates/Formats and Conversions","content":"","keywords":"IT  KnowledgeBase  Microsoft  Azure  Computers"},{"title":"Document Control​","type":1,"pageTitle":"Certificate formats and Converting formats","url":"/Certificates/Formats and Conversions#document-control","content":"Created: 27/04/23Last Updated: 27/04/23 "},{"title":"Certificate Formats​","type":1,"pageTitle":"Certificate formats and Converting formats","url":"/Certificates/Formats and Conversions#certificate-formats","content":"All you need to know is that there are several file extension types and encoding formats. Plus, in order to successfully install an SSL on your server, you need to know which type exactly your server or device requires. "},{"title":"X.509 certificate encoding formats and extensions​","type":1,"pageTitle":"Certificate formats and Converting formats","url":"/Certificates/Formats and Conversions#x509-certificate-encoding-formats-and-extensions","content":".pem, .crt, .ca-bundle, .cer, .p7b, .p7s files contain one or more X.509 digital certificate files that use base64 (ASCII) encoding. You get one of those in a zip file. You may also encounter *.pfx files. This is an archive file format for storing several cryptographic objects in a single file. In the scope of SSL certificates for SSL/TLS client and SSL/TLS web server authentication, a .pfx file must contain the end-entity certificate (issued for your domain), a matching private key, and may optionally include an intermediate certification authority (a.k.a. a CA Bundle). All this is wrapped up in a single file which is then protected with a pfx password. A Private key must be kept secret and is something that you generate alongside with the certificate signing request (CSR) by using an available tool. PEM (Base64 (ASCII))​ A PEM file is a text format, the pem file contains the certificates inforamtion in a Hash format, which can be placed into an application. .pem.crt.ca-bundle You can decode the Hash using a tool such as this online one, paste the text into the tool for it to show you the information. https://www.sslshopper.com/certificate-decoder.html  You can also do this using OpenSSL from your computer with the command openssl x509 -in certificate.crt -text -noout PKCS#7 (Base64 (ASCII))​ Are mostly used in Windows or Java-based server environments (e.g. Internet Information Server (IIS), MS Exchange server, Java Tomcat, etc). PKCS#7 certificate file includes the end-entity certificate (the one issued to your domain name), plus one or more trusted intermediate certification authority files. .p7b.p7s DER (Binary)​ .der.cer These files are very often used for Microsoft IIS services. PKCS#12 (Binary)​ .pfx.p12 "},{"title":"Convertion to different formats​","type":1,"pageTitle":"Certificate formats and Converting formats","url":"/Certificates/Formats and Conversions#convertion-to-different-formats","content":""},{"title":"Open SSL​","type":1,"pageTitle":"Certificate formats and Converting formats","url":"/Certificates/Formats and Conversions#open-ssl","content":"Installing Open SSL​ Install Chocolatey (Package Manager), Link to document . "},{"title":"Using Open SSL​","type":1,"pageTitle":"Certificate formats and Converting formats","url":"/Certificates/Formats and Conversions#using-open-ssl","content":"Before you begin​ Create a folder and place the pfx file into the folder.To load openssl, open cmd as admin, navigate to “C:\\Program Files\\OpenSSL-Win64”, run the start.bat file to launch openssl.Change to the folder containing the pfx file and run the following commands. PFX file with separate key file​ Follow the guidance in the above section before proceeding. Type the following commands into your admin command prompt. openssl pkcs12 -in nameofyourcertificate.pfx -nocerts -nodes -out privatekey.keyopenssl pkcs12 -in nameofyourcertificate.pfx -clcerts -nokeys -out certificate.cer This will create a privatekey.key file (containing the private keys) and certificate.cer (containing the certificate). PFX to PEM with Private Key File​ Stack OverFlow link. Follow the guidance in the Before you begin section above before proceeding. To convert a PFX file to a PEM file that contains both the certificate and private key (you'll need the private key for the PFX file to do this). openssl pkcs12 -in filename.pfx -out cert.pem -nodes To convert a PFX file to separate public and private key PEM files (you'll need the private key for the PFX file to do this): Extracts the private key form a PFX to a PEM file: openssl pkcs12 -in filename.pfx -nocerts -out key.pem Exports the certificate (includes the public key only): openssl pkcs12 -in filename.pfx -clcerts -nokeys -out cert.pem Removes the password (paraphrase) from the extracted private key (optional): openssl rsa -in key.pem -out server.key "},{"title":"Windows OS Scripts","type":0,"sectionRef":"#","url":"/Scripts/Windows OS Scripts","content":"","keywords":"IT  KnowledgeBase  Microsoft  Azure  Computers"},{"title":"Document Control​","type":1,"pageTitle":"Windows OS Scripts","url":"/Scripts/Windows OS Scripts#document-control","content":"Created: 2023/03/30Last Updated: 2023/04/01 "},{"title":"Folder size report (Get-childitem)​","type":1,"pageTitle":"Windows OS Scripts","url":"/Scripts/Windows OS Scripts#folder-size-report-get-childitem","content":"$startFolder = &quot;C:\\FolderName&quot; $colItems = Get-ChildItem $startFolder | Where-Object {$_.PSIsContainer -eq $true} | Sort-Object foreach ($i in $colItems) { $subFolderItems = Get-ChildItem $i.FullName -recurse -force | Where-Object {$_.PSIsContainer -eq $false} | Measure-Object -property Length -sum | Select-Object Sum $i.FullName + ” — ” + “{0:N2}” -f ($subFolderItems.sum / 1GB) + ” GB” }  "},{"title":"Service Management (Stop-Service, Start-Service)​","type":1,"pageTitle":"Windows OS Scripts","url":"/Scripts/Windows OS Scripts#service-management-stop-service-start-service","content":" $serviceName = Get-Service -Name &quot;*ServiceName*&quot; if ($serviceName.Status -ne 'Stopped') { &lt;# Action to perform if the service is running still. #&gt; Write-Host &quot;The script has detected that the ' $serviceName.Name ' is still running.&quot; -ForegroundColor Yellow WriteToLogFile &quot;$(Get-Date) - The $($serviceName.Name), is still running.&quot; Start-Sleep 3 try { Write-Progress -Activity &quot;Attempting to stop the service&quot; -Status 'Stopping' WriteToLogFile &quot;$(Get-Date) - Attempting to stop the service.&quot; Stop-Service -Name $serviceName.Name Start-Sleep 5 } catch { Write-Host &quot;An error occurred, see below error and the log for more information.&quot; } $serviceName = Get-Service -Name &quot;*ServiceName*&quot; # Stores the new service status in the variable. Start-Sleep 2  "},{"title":"Az Cli","type":0,"sectionRef":"#","url":"/Command Line References/AzCLi","content":"","keywords":"IT  KnowledgeBase  Microsoft  Azure  Computers"},{"title":"Document Control​","type":1,"pageTitle":"Az Cli","url":"/Command Line References/AzCLi#document-control","content":"Created: 23/04/22Last Updated: 23/04/22 "},{"title":"Querying (Filtering)​","type":1,"pageTitle":"Az Cli","url":"/Command Line References/AzCLi#querying-filtering","content":"Single item search from an outputaz vm show --resource-group RG-WHDOMAIN-EUS-CORE --name vm-whdom-eus-dc-01 --query &quot;hardwareProfile&quot; -o table Multiple Item search from an output, formatted to a table. # You're passing the array to the filters to the right of the '.',. # The format Name:config item, names he heading for the values collected. az vm list --query &quot;[].{Name:name, Location:location, RG:resourceGroup, Size:hardwareProfile.vmSize}&quot; -o table  "},{"title":"List VMs​","type":1,"pageTitle":"Az Cli","url":"/Command Line References/AzCLi#list-vms","content":"az vm list az vm list --output table az vm list -o table  "},{"title":"NSG Flow log Formatter","type":0,"sectionRef":"#","url":"/Scripts/NSG Flow log Formatter","content":"","keywords":"IT  KnowledgeBase  Microsoft  Azure  Computers"},{"title":"Document Control​","type":1,"pageTitle":"NSG Flow log Formatter","url":"/Scripts/NSG Flow log Formatter#document-control","content":"Created: 23/04/22Last Updated: 23/04/22 "},{"title":"Script​","type":1,"pageTitle":"NSG Flow log Formatter","url":"/Scripts/NSG Flow log Formatter#script","content":"info I didn't write this script, I cannot take any credit for it! Takes a input json format Azure NSG Flow Log file using -$NsgFlowLogFileName command line option cd C:\\Temp\\ .\\Parse-NSG-FlowLog_json.ps1 -NsgFlowLogFileName .\\PT1H.json | ft -AutoSize  param( [string]$NsgFlowLogFileName = &quot;C:\\Temp\\filename.json&quot; ) # Import the logs from the file convert it from json into a powershell object $logs = gc $NsgFlowLogFileName -ErrorAction SilentlyContinue | ConvertFrom-Json | select -ExpandProperty records # Loop through each entry in the json file foreach ($Log in $Logs) { #Get a list of flows $Flows = $log.properties.flows # Loop through each flow of each json entry and output the details foreach ($Flow in $Flows) { # Split the flow information to a variable for easier and quicker referencing $FlowInfo = $Flow.flows.flowtuples[0] -split(',') # Output details as a powershell object [pscustomobject]@{ DateTime = (Get-Date 01.01.1970)+([System.TimeSpan]::fromseconds($FlowInfo[0])) # Converts time format. NSGName = $Log.resourceId.split('/')[-1] RuleName = $Flow.rule Decision = switch ($FlowInfo[7]) { 'a' { &quot;Allowed&quot; } ; &quot;d&quot; {&quot;Denied&quot;} } FlowState = switch ($FlowInfo[8]) { 'B' { &quot;Begin&quot; } ; &quot;C&quot; {&quot;Continue&quot;} ; &quot;e&quot; {&quot;End&quot;} } SourceIP = $FlowInfo[1] SourcePort = $FlowInfo[3] DestIP = $FlowInfo[2] DestPort = $FlowInfo[4] Protocol = switch ($FlowInfo[5]) { 't' { &quot;TCP&quot; } ; &quot;u&quot; {&quot;UDP&quot;} } Direction = switch ($FlowInfo[6]) { 'i' { &quot;InBound&quot; } ; &quot;o&quot; {&quot;OutBound&quot;} } SourcePackets = $FlowInfo[9] SourceBytes = $FlowInfo[10] DestPackets = $FlowInfo[11] DestBytes = $FlowInfo[12] # Below line ends the flow loop, then filters out the empty entries. } | where SourceIP -ne $null } }  "},{"title":"Microsoft Graph","type":0,"sectionRef":"#","url":"/Command Line References/Microsoft Graph","content":"","keywords":"IT  KnowledgeBase  Microsoft  Azure  Computers"},{"title":"Document Control​","type":1,"pageTitle":"Microsoft Graph","url":"/Command Line References/Microsoft Graph#document-control","content":"Created: 2023/04/22Last Updated: 2023/04/22 "},{"title":"Module Management​","type":1,"pageTitle":"Microsoft Graph","url":"/Command Line References/Microsoft Graph#module-management","content":""},{"title":"Permissions Scopes​","type":1,"pageTitle":"Microsoft Graph","url":"/Command Line References/Microsoft Graph#permissions-scopes","content":"MG Graph uses permissions scopes that you assign at logon, use the command below to locate what permissions scopes you need for your logged in session. Find-MgGraphCommand -command Get-MgUser | Select -First 1 -ExpandProperty Permissions  "},{"title":"Connect & Update​","type":1,"pageTitle":"Microsoft Graph","url":"/Command Line References/Microsoft Graph#connect--update","content":"Connect-MGGraph Update-Module -Name Microsoft.Graph  "},{"title":"Connect to MG Graph with Read-only permissions​","type":1,"pageTitle":"Microsoft Graph","url":"/Command Line References/Microsoft Graph#connect-to-mg-graph-with-read-only-permissions","content":"Connect-MGGraph This will connect with read only permissions to manage Users and Devices. Connect-MgGraph &quot;User.Read.All&quot;, &quot;Calendars.Read.Shared&quot;, &quot;DeviceManagementRBAC.Read.All&quot;, &quot;DeviceManagementServiceConfig.Read.All&quot;, &quot;DeviceManagementConfiguration.Read.All&quot;, &quot;DeviceManagementManagedDevices.Read.All&quot;  "},{"title":"Getting properties from commands​","type":1,"pageTitle":"Microsoft Graph","url":"/Command Line References/Microsoft Graph#getting-properties-from-commands","content":"Getting properties using MGGraph requires &quot;declaring&quot; them as part of the original command, if you don't so this they will be blank in the following commands or pipe. For example, get-mguser -userid username@domain.com | select UserPrincipalName, DisplayName, LastPasswordChangeDateTime will return the UPn &amp; display name but, LastPasswordChangeDateTime will be blank. You would need to type the command in this format, get-mguser -userid username@domain.com -property -Property UserPrincipalName, DisplayName, LastPasswordChangeDateTime | select UserPrincipalName, DisplayName, LastPasswordChangeDateTime.  "},{"title":"User Management​","type":1,"pageTitle":"Microsoft Graph","url":"/Command Line References/Microsoft Graph#user-management","content":""},{"title":"Grab basic user information to work with​","type":1,"pageTitle":"Microsoft Graph","url":"/Command Line References/Microsoft Graph#grab-basic-user-information-to-work-with","content":"$userReport = Get-MgUser -All -property DisplayName, UserPrincipalName, AssignedLicenses, businessphones, CompanyName, CreatedDateTime, Id, jobTitle, LastPasswordChangeDateTime, MobilePhone, Manager, Usertype | ` Select DisplayName, UserPrincipalName, AssignedLicenses, businessphones, CompanyName, CreatedDateTime, Id, jobTitle, LastPasswordChangeDateTime, MobilePhone, Manager, Usertype  "},{"title":"Grab a password report of all users.​","type":1,"pageTitle":"Microsoft Graph","url":"/Command Line References/Microsoft Graph#grab-a-password-report-of-all-users","content":"Get-MgUser -All -Property UserPrincipalName, DisplayName, Id, LastPasswordChangeDateTime,PasswordPolicies | ` Select-Object UserPrincipalName, DisplayName, LastPasswordChangeDateTime,PasswordPolicies, @{l='PasswordAgeDays';e={ (New-TimeSpan -Start $_.LastPasswordChangeDateTime -End (get-date) )TotalDays -as [int] }} | ` Sort-Object PasswordAgeDays  "},{"title":"Device management​","type":1,"pageTitle":"Microsoft Graph","url":"/Command Line References/Microsoft Graph#device-management","content":""},{"title":"Get devices from Intune with their Primary User​","type":1,"pageTitle":"Microsoft Graph","url":"/Command Line References/Microsoft Graph#get-devices-from-intune-with-their-primary-user","content":"Get-MgDeviceManagementManagedDevice # Connect with the relevant permission to read all user and device data. Connect-MgGraph &quot;User.Read.All&quot;, &quot;DeviceManagementRBAC.Read.All&quot;, &quot;DeviceManagementServiceConfig.Read.All&quot;, &quot;DeviceManagementConfiguration.Read.All&quot;, &quot;DeviceManagementManagedDevices.Read.All&quot; $getAllDevices = Get-MgDeviceManagementManagedDevice -All | ` Select DeviceName, UserPrincipalName, EnrolledDateTime, ComplianceState, IsEncrypted, LastSyncDateTime, Id , Manufacturer, Model, OperatingSystem, OSVersion, SerialNumber,@{l='PrimaryUser';e={ $device = $_ ; Get-MgDeviceManagementManagedDeviceUser -ManagedDeviceId $device.id | select -expandproperty UserPrincipalName }} | ` Sort OperatingSystem  "},{"title":"Get Generic Device Report from intune​","type":1,"pageTitle":"Microsoft Graph","url":"/Command Line References/Microsoft Graph#get-generic-device-report-from-intune","content":"# Connect with the relevant permission to read all user and device data. Connect-MgGraph &quot;User.Read.All&quot;, &quot;DeviceManagementRBAC.Read.All&quot;, &quot;DeviceManagementServiceConfig.Read.All&quot;, &quot;DeviceManagementConfiguration.Read.All&quot;, &quot;DeviceManagementManagedDevices.Read.All&quot; # Get all intune &quot;Managed&quot; devices. Get-MgDeviceManagementManagedDevice -All | select DeviceName, AzureAdDeviceId, UserPrincipalName, Id, ComplianceState, EnrolledDateTime, LastSyncDateTime, Manufacturer, Model, OSVersion, SerialNumber | sort UserPrincipalName | ft -AutoSize  "},{"title":"Get a list of Configuration Profiles from Intune​","type":1,"pageTitle":"Microsoft Graph","url":"/Command Line References/Microsoft Graph#get-a-list-of-configuration-profiles-from-intune","content":"Get-MgDeviceManagementDeviceConfiguration # Get Configuration Profiles for an Org. Get-MgDeviceManagementDeviceConfiguration -All | select Id, DisplayName  "},{"title":"Get a list of Compliance policies from Intune​","type":1,"pageTitle":"Microsoft Graph","url":"/Command Line References/Microsoft Graph#get-a-list-of-compliance-policies-from-intune","content":"Get-MgDeviceManagementDeviceCompliancePolicy # Get Compliance policies for an Org. Get-MgDeviceManagementDeviceCompliancePolicy -All | Select Displayname,LastModifiedDateTime, Id  Get a compliancy report for a compliance policy​ Get-MgDeviceManagementDeviceCompliancePolicyDeviceStatuses # Get Compliancy report for a policy Get-MgDeviceManagementDeviceCompliancePolicyDeviceStatuses -DeviceCompliancePolicyId 6ac10074-0704-46d1-8fe2-04fa03d413d4 | Select DeviceDisplayName, Status, UserName  Get a compliance policy report for a single device​ Get-MgDeviceManagementManagedDeviceCompliancePolicyState # Device Compliancy for a single device. Get-MgDeviceManagementManagedDeviceCompliancePolicyState -ManagedDeviceId f2c1e6c3-9330-41c9-9a91-50302c20655d  "},{"title":"Network Security Groups","type":0,"sectionRef":"#","url":"/Azure/Networking/Network Security Groups","content":"","keywords":"IT  KnowledgeBase  Microsoft  Azure  Computers"},{"title":"Document Control​","type":1,"pageTitle":"Network Security Groups","url":"/Azure/Networking/Network Security Groups#document-control","content":"Created: 23/04/23Last Updated: 23/04/23 "},{"title":"Rules and priority suggestions​","type":1,"pageTitle":"Network Security Groups","url":"/Azure/Networking/Network Security Groups#rules-and-priority-suggestions","content":""},{"title":"Service Tags​","type":1,"pageTitle":"Network Security Groups","url":"/Azure/Networking/Network Security Groups#service-tags","content":"Virtual Network Service tags | Microsoft doc link A service tag represents a group of IP address prefixes from a given Azure service. Microsoft manages the address prefixes encompassed by the service tag and automatically updates the service tag as addresses change, minimizing the complexity of frequent updates to network security rules. "},{"title":"Rule Priority​","type":1,"pageTitle":"Network Security Groups","url":"/Azure/Networking/Network Security Groups#rule-priority","content":"A number between 100 and 4096. Rules are processed in priority order, with lower numbers processed before higher numbers, because lower numbers have higher priority. Once traffic matches a rule, processing stops. As a result, any rules that exist with lower priorities (higher numbers) that have the same attributes as rules with higher priorities aren’t processed. "},{"title":"Inbound Rule Suggestions​","type":1,"pageTitle":"Network Security Groups","url":"/Azure/Networking/Network Security Groups#inbound-rule-suggestions","content":"Priority\tName\tPort\tprotocol\tSource\tDestination\tAction\tNotes100 to 109 100 to 109 available for overrides 110 to 199 200\tDeny-Internet-to-Any\tAny\tAny\tInternet (Service tag)\tAny\tDeny\tDeny All inbound Internet access. 200 to 299\tAllow any internal vNet services\t-\t-\t-\t-\t-\tAllow any internal vNet services 300\tDeny-From-VNET-to-VNET\tAny\tAny\tAny\tAny\tDeny\t- 301 to 64999\tFor non-vnet or internet facing rules\t-\t-\t-\t-\t-\tFor non-vnet or internet facing rules 65000\tAllowVnetInBound\tAny\tAny\tVirtualNetwork\tVirtualNetwork\tAllow\tBuilt in Rule 65000 to 65500\tAre built in rules\t-\t-\t-\t-\t-\tAre built in rules 65001\tAllowAzureLoadBalancerInBound\tAny\tAny\tAzureLoadBalancer\tAny\tAllow\tBuilt in Rule 65500\tDenyAllInBound\tAny\tAny\tAny\tAny\tDeny\tBuilt in Rule "},{"title":"Outbound Rule Suggestions​","type":1,"pageTitle":"Network Security Groups","url":"/Azure/Networking/Network Security Groups#outbound-rule-suggestions","content":"Priority\tName\tPort\tprotocol\tSource\tDestination\tAction\tNotes100 to 109\t100 to 109\tavailable for overrides\t-\t-\t-\t-\t100 to 109 available for overrides 110 to 199\tAllow any inbound internet services.\t-\t-\t-\t-\t-\tAllow any inbound internet services. 111\tAllow http\t80\tTCP\t0.0.0.0/24\tInternet (Service Tag)\tAllow\tAllow http services to internet. 112\tAll https\t443\tTCP\t0.0.0.0/24\tInternet (Service Tag)\tAllow\tAllow https services to internet. 114\tAllow-DNS-to-MicrosoftAzure\t53\tAny\t0.0.0.0/24\t168.63.129.16\tAllow\tAllow DNS to Azure IP 115\tAllow-AADConnect-to-AzureAD\t443,80\tTCP\t10.125.8.13\tAzureAzureActiveDirectory (Service Tag)\tAllow\tAllow Allow AAD Connect services. 116\tAllow-Azuresiterecovery\t443,80\tTCP\t0.0.0.0/24\tAzureSiteRecovery\tAllow\tAllow Azure Site Recovery services. 117\tAllow-AzureKeyVault\t443,80\tTCP\t0.0.0.0/24\tAzureKeyVault\tAllow\tAllow Azure Key Vault services. (Dependency for ASR). 118\tAllow-GuestAndHybridManagement\t443,80\tTCP\t0.0.0.0/24\tGuestAndHybridManagement\tAllow\tAllow Guest and Hybrid Management services. (Dependency for ASR, AzMonitor). 119\tAllow-Storage\t443,80\tTCP\t0.0.0.0/24\tStorage\tAllow\tAllow Storage services. (Dependency for ASR, AzMonitor). 120\tAllow-EventHub\t443,80\tTCP\t0.0.0.0/24\tEventHub\tAllow\tAllow Event Hub services. (Dependency for ASR). 121\tAllow-AzureMonitor\t443,80\tTCP\t0.0.0.0/24\tAzureMonitor\tAllow\tAllow Event Hub services. (Dependency for ASR). 122\tAllow-WindowsUpdate-AzUpdateDeliver\t443,80\tTCP\t0.0.0.0/24\tAzureUpdateDelivery (Service Tag)\tAllow\tAllow Az update delivery services 123\tAllow-WindowsUpdate-AzFrontDoorFP\t443,80\tTCP\t0.0.0.0/24\tAzureFrontDoor.FirstParty (Service Tag)\tAllow\tAllow Az update delivery services 200\tDeny-Internet-to-Any\tAny\tAny\tInternet (Service tag)\tAny\tDeny\tDeny All inbound Internet access. 200 to 299\tAllow any internal vNet services\t-\t-\t-\t-\t-\tAllow any internal vNet services 300\tDeny-From-VNET-to-VNET\tAny\tAny\tAny\tAny\tDeny\t- 301 to 64999\tFor non-vnet or internet facing rules\t-\t-\t-\t-\t-\tFor non-vnet or internet facing rules 65000\tAllowVnetInBound\tAny\tAny\tVirtualNetwork\tVirtualNetwork\tAllow Built in Rule 65000 to 65500\tAre built in rules\t-\t-\t-\t-\t-\tAre built in rules "},{"title":"NSG Flow Logs​","type":1,"pageTitle":"Network Security Groups","url":"/Azure/Networking/Network Security Groups#nsg-flow-logs","content":"NSG flow logs is a feature of Azure Network Watcher that allows you to log information about IP traffic flowing through a network security group (NSG). Flow data is sent to Azure Storage from where you can access it and export it to any visualization tool. Flow logs for network security groups | Microsoft doc link "},{"title":"Common use cases​","type":1,"pageTitle":"Network Security Groups","url":"/Azure/Networking/Network Security Groups#common-use-cases","content":"Sources All of the below information has been ripped out of a Microsoft doc, not my original material. "},{"title":"Network monitoring​","type":1,"pageTitle":"Network Security Groups","url":"/Azure/Networking/Network Security Groups#network-monitoring","content":"Identify unknown or undesired traffic.Monitor traffic levels and bandwidth consumption.Filter flow logs by IP and port to understand application behavior.Export flow logs to analytics and visualization tools of your choice to set up monitoring dashboards. "},{"title":"Usage monitoring and optimization​","type":1,"pageTitle":"Network Security Groups","url":"/Azure/Networking/Network Security Groups#usage-monitoring-and-optimization","content":"Identify top talkers in your network.Combine with GeoIP data to identify cross-region traffic.Understand traffic growth for capacity forecasting.Use data to remove overly restrictive traffic rules. "},{"title":"Compliance​","type":1,"pageTitle":"Network Security Groups","url":"/Azure/Networking/Network Security Groups#compliance","content":"Use flow data to verify network isolation and compliance with enterprise access rules.Network forensics and security analysisAnalyze network flows from compromised IPs and network interfaces.Export flow logs to any SIEM or IDS tool of your choice. "},{"title":"Reading the flow log​","type":1,"pageTitle":"Network Security Groups","url":"/Azure/Networking/Network Security Groups#reading-the-flow-log","content":"Logs are in JSON format and will be outputting in the json file format.The information that is interesting is in the flowtuples section of the json file. "},{"title":"Example flow log entry​","type":1,"pageTitle":"Network Security Groups","url":"/Azure/Networking/Network Security Groups#example-flow-log-entry","content":"{ &quot;records&quot;: [ { &quot;time&quot;: &quot;2018-11-13T12:00:35.3899262Z&quot;, &quot;systemId&quot;: &quot;a0fca5ce-022c-47b1-9735-89943b42f2fa&quot;, &quot;category&quot;: &quot;NetworkSecurityGroupFlowEvent&quot;, &quot;resourceId&quot;: &quot;/SUBSCRIPTIONS/00000000-0000-0000-0000-000000000000/RESOURCEGROUPS/FABRIKAMRG/PROVIDERS/MICROSOFT.NETWORK/NETWORKSECURITYGROUPS/FABRIAKMVM1-NSG&quot;, &quot;operationName&quot;: &quot;NetworkSecurityGroupFlowEvents&quot;, &quot;properties&quot;: { &quot;Version&quot;: 2, &quot;flows&quot;: [ { &quot;rule&quot;: &quot;DefaultRule_DenyAllInBound&quot;, &quot;flows&quot;: [ { &quot;mac&quot;: &quot;000D3AF87856&quot;, &quot;flowTuples&quot;: [ &quot;1542110402,94.102.49.190,10.5.16.4,28746,443,U,I,D,B,,,,&quot;, &quot;1542110424,176.119.4.10,10.5.16.4,56509,59336,T,I,D,B,,,,&quot;, &quot;1542110432,167.99.86.8,10.5.16.4,48495,8088,T,I,D,B,,,,&quot; ] } ] }, { &quot;rule&quot;: &quot;DefaultRule_AllowInternetOutBound&quot;, &quot;flows&quot;: [ { &quot;mac&quot;: &quot;000D3AF87856&quot;, &quot;flowTuples&quot;: [ &quot;1542110377,10.5.16.4,13.67.143.118,59831,443,T,O,A,B,,,,&quot;, &quot;1542110379,10.5.16.4,13.67.143.117,59932,443,T,O,A,E,1,66,1,66&quot;, &quot;1542110379,10.5.16.4,13.67.143.115,44931,443,T,O,A,C,30,16978,24,14008&quot;, &quot;1542110406,10.5.16.4,40.71.12.225,59929,443,T,O,A,E,15,8489,12,7054&quot; ] } ] } ] } }, { &quot;time&quot;: &quot;2018-11-13T12:01:35.3918317Z&quot;, &quot;systemId&quot;: &quot;a0fca5ce-022c-47b1-9735-89943b42f2fa&quot;, &quot;category&quot;: &quot;NetworkSecurityGroupFlowEvent&quot;, &quot;resourceId&quot;: &quot;/SUBSCRIPTIONS/00000000-0000-0000-0000-000000000000/RESOURCEGROUPS/FABRIKAMRG/PROVIDERS/MICROSOFT.NETWORK/NETWORKSECURITYGROUPS/FABRIAKMVM1-NSG&quot;, &quot;operationName&quot;: &quot;NetworkSecurityGroupFlowEvents&quot;, &quot;properties&quot;: { &quot;Version&quot;: 2, &quot;flows&quot;: [ { &quot;rule&quot;: &quot;DefaultRule_DenyAllInBound&quot;, &quot;flows&quot;: [ { &quot;mac&quot;: &quot;000D3AF87856&quot;, &quot;flowTuples&quot;: [ &quot;1542110437,125.64.94.197,10.5.16.4,59752,18264,T,I,D,B,,,,&quot;, &quot;1542110475,80.211.72.221,10.5.16.4,37433,8088,T,I,D,B,,,,&quot;, &quot;1542110487,46.101.199.124,10.5.16.4,60577,8088,T,I,D,B,,,,&quot;, &quot;1542110490,176.119.4.30,10.5.16.4,57067,52801,T,I,D,B,,,,&quot; ] } ] } ] } }  "},{"title":"Flow Tuples​","type":1,"pageTitle":"Network Security Groups","url":"/Azure/Networking/Network Security Groups#flow-tuples","content":"flowTuples: String that contains multiple properties for the flow tuple in a comma-separated format Example entry: 1493695838,185.170.185.105,10.2.0.4,35370,23,T,I,A,C,1021,588096,8005,4610880  "},{"title":"Script to read the logs via PowerShell​","type":1,"pageTitle":"Network Security Groups","url":"/Azure/Networking/Network Security Groups#script-to-read-the-logs-via-powershell","content":"Dump the below into a file as a script (.ps1) filetype. To use the script below, navigate to the location of the file, and use the NsgFlowLogFileName switch to select the JSON file. cd C:\\Temp\\ .\\Parse-NSG-FlowLog_json.ps1 -NsgFlowLogFileName .\\PT1H.json | ft -AutoSize  info I didn't write this script, I cannot take any credit for it! param( [string]$NsgFlowLogFileName = &quot;C:\\Temp\\filename.json&quot; ) # Import the logs from the file convert it from json into a powershell object $logs = gc $NsgFlowLogFileName -ErrorAction SilentlyContinue | ConvertFrom-Json | select -ExpandProperty records # Loop through each entry in the json file foreach ($Log in $Logs) { #Get a list of flows $Flows = $log.properties.flows # Loop through each flow of each json entry and output the details foreach ($Flow in $Flows) { # Split the flow information to a variable for easier and quicker referencing $FlowInfo = $Flow.flows.flowtuples[0] -split(',') # Output details as a powershell object [pscustomobject]@{ DateTime = (Get-Date 01.01.1970)+([System.TimeSpan]::fromseconds($FlowInfo[0])) # Converts time format. NSGName = $Log.resourceId.split('/')[-1] RuleName = $Flow.rule Decision = switch ($FlowInfo[7]) { 'a' { &quot;Allowed&quot; } ; &quot;d&quot; {&quot;Denied&quot;} } FlowState = switch ($FlowInfo[8]) { 'B' { &quot;Begin&quot; } ; &quot;C&quot; {&quot;Continue&quot;} ; &quot;e&quot; {&quot;End&quot;} } SourceIP = $FlowInfo[1] SourcePort = $FlowInfo[3] DestIP = $FlowInfo[2] DestPort = $FlowInfo[4] Protocol = switch ($FlowInfo[5]) { 't' { &quot;TCP&quot; } ; &quot;u&quot; {&quot;UDP&quot;} } Direction = switch ($FlowInfo[6]) { 'i' { &quot;InBound&quot; } ; &quot;o&quot; {&quot;OutBound&quot;} } SourcePackets = $FlowInfo[9] SourceBytes = $FlowInfo[10] DestPackets = $FlowInfo[11] DestBytes = $FlowInfo[12] # Below line ends the flow loop, then filters out the empty entries. } | where SourceIP -ne $null } }  "},{"title":"PowerShell","type":0,"sectionRef":"#","url":"/Command Line References/PowerShell","content":"","keywords":"IT  KnowledgeBase  Microsoft  Azure  Computers"},{"title":"Document Control​","type":1,"pageTitle":"PowerShell","url":"/Command Line References/PowerShell#document-control","content":"Created: 23/04/22Last Updated: 23/04/22 "},{"title":"Credential Management​","type":1,"pageTitle":"PowerShell","url":"/Command Line References/PowerShell#credential-management","content":""},{"title":"Collect and encrypt credentials​","type":1,"pageTitle":"PowerShell","url":"/Command Line References/PowerShell#collect-and-encrypt-credentials","content":"$credential = Get-Credential $credential.Password | ConvertFrom-SecureString | Set-Content &quot;C:\\temp\\Reporting\\encrypted_password_for_reporting.txt&quot; &lt;# Decrypting it and using it in a script#&gt; # Get the credential $emailusername = &quot;email.address@domain.com&quot; $encrypted = Get-Content &quot;C:\\temp\\encrypted_password_for_reporting.txt&quot; | ConvertTo-SecureString $credential = New-Object System.Management.Automation.PsCredential($emailusername, $encrypted)  "},{"title":"User confirmation statement​","type":1,"pageTitle":"PowerShell","url":"/Command Line References/PowerShell#user-confirmation-statement","content":"&lt;# Disclaimer to confirm user is happy to begin the process. #&gt; Write-Host &quot;Write your warning text here.&quot; -ForegroundColor Yellow Start-Sleep 2 $decisionConfirmation = Read-Host &quot;Are you sure you wish to proceed. Type Y to begin or N to stop here [y/n].&quot; if ($decisionConfirmation -ne 'y') { &lt;# Action if statement is true. #&gt; Write-Host &quot;The script will not proceed any further.&quot; -ForegroundColor Red WriteToLogFile &quot;$(Get-Date) - User selected to not proceed with the script, terminating.&quot; # 'Script terminated.' }  "},{"title":"Error Management​","type":1,"pageTitle":"PowerShell","url":"/Command Line References/PowerShell#error-management","content":""},{"title":"Try and Catch example for error debugging​","type":1,"pageTitle":"PowerShell","url":"/Command Line References/PowerShell#try-and-catch-example-for-error-debugging","content":"try { Connect-AzAccount -Identity } catch{ Write-Output &quot;Unable to login. Aborting.&quot;; exit }  "},{"title":"Create a log file​","type":1,"pageTitle":"PowerShell","url":"/Command Line References/PowerShell#create-a-log-file","content":"The below is a small function that creates the log file and a new command WriteToLogFile, which will add the content to the log file. $date = Get-Date -Format dd-mm-yyyy $logFileLocation = &quot;C:\\Temp\\&quot; &lt;# Create the log file. #&gt; try { &lt;# Try the following. #&gt; function WriteToLogFile ($message) { Add-Content $logFileLocation\\LogFile_$date.log -Value $message } if (Test-Path $logFileLocation\\LogFile_$date.log) { Write-Host 'Log file already exists, deleting and re-creating.' Start-Sleep 2 Remove-Item $logFileLocation\\LogFile_$date.log } WriteToLogFile &quot;$(Get-Date) - Log File created.&quot; } catch { &lt;# Collect and report any errors. #&gt; Write-Host &quot;Failed to create log file at the following location:&quot;$logFileLocation -ForegroundColor Red&quot;, continuing without logging.&quot; Write-Host $_ -ForegroundColor Red WriteToLogFile &quot;$(Get-Date) - $($_)&quot; throw 'Script terminated.' }  "},{"title":"Test multiple item paths​","type":1,"pageTitle":"PowerShell","url":"/Command Line References/PowerShell#test-multiple-item-paths","content":"Test-Path Test multiple paths for files or folders. Test-Path &quot;$Variable1&quot;, &quot;$Variable2&quot;, &quot;$Variable3&quot;  "},{"title":"Importing, Formatting & Searching​","type":1,"pageTitle":"PowerShell","url":"/Command Line References/PowerShell#importing-formatting--searching","content":""},{"title":"Folder Size Report​","type":1,"pageTitle":"PowerShell","url":"/Command Line References/PowerShell#folder-size-report","content":"$directory = C:\\Users\\whornsby # Retrieve the files and the total size of them combines. Note that Folders do not hold file sizes. $getFileSizes | Get-ChildItem -Recurse | Measure-Object -Sum Length | Select-Object @{Name=”Path”; Expression={$directory.FullName}}, @{Name=”Files”; Expression={$_.Count}}, @{Name=”Size(GB)”; Expression={$_.Sum/1GB}} # Converts output to GB $_.Sum/1GB # Converts output to MB $_.Sum/1MB  "},{"title":"Import and filter CSV Files​","type":1,"pageTitle":"PowerShell","url":"/Command Line References/PowerShell#import-and-filter-csv-files","content":"ImportFrom-CSV $csvFile = Import-Csv 'C:\\Temp\\File.csv' # Edited export with devices status notes. # Filter Examples $csvFile | group osVersion $csvFile | group osVersion | select -ExpandProperty property Name| ft -AutoSize  "},{"title":"Windows OS​","type":1,"pageTitle":"PowerShell","url":"/Command Line References/PowerShell#windows-os","content":""},{"title":"Collect System information​","type":1,"pageTitle":"PowerShell","url":"/Command Line References/PowerShell#collect-system-information","content":"systeminfo &lt;#The Command below relies on there being a folder created before running the command, use the command below to do this if needed.#&gt; New-Item &quot;C:\\SystemDiagnosticCollection&quot; -itemType Directory # Creates the folder and the desired path. Write-host 'Folder created at C:\\SystemDiagnosticCollection' # Add this if you're writing a script where you need to update the PowerShell prompt. systeminfo | Out-File -FilePath C:\\SystemDiagnosticCollection\\SystemInfo.txt # Command collects the systeminfo data and dumps it to text file. Write-host 'System Info Collected' # Add this if you're writing a script where you need to update the PowerShell prompt.  "},{"title":"Collect IP address info​","type":1,"pageTitle":"PowerShell","url":"/Command Line References/PowerShell#collect-ip-address-info","content":"Ipconfig &lt;#The Command below relies on there being a folder created before running the command, use the command below to do this if needed.#&gt; New-Item &quot;C:\\SystemDiagnosticCollection&quot; -itemType Directory # Creates the folder and the desired path. Write-host 'Folder created at C:\\SystemDiagnosticCollection' # Add this if you're writing a script where you need to update the PowerShell prompt. ipconfig /all | Out-File -FilePath C:\\SystemDiagnosticCollection\\IpAddressingInfo.txt # Collects the IP info and dumps it to text file. Write-host 'ipconfig ran successfully' # Add this if you're writing a script where you need to update the PowerShell prompt.  "},{"title":"Test Connection​","type":1,"pageTitle":"PowerShell","url":"/Command Line References/PowerShell#test-connection","content":"Test-NetConnection &lt;#The Command below relies on there being a folder created before running the command, use the command below to do this if needed.#&gt; New-Item &quot;C:\\SystemDiagnosticCollection&quot; -itemType Directory # Creates the folder and the desired path. Write-host 'Folder created at C:\\SystemDiagnosticCollection' # Add this if you're writing a script where you need to update the PowerShell prompt. # Test Connection to Google Test-NetConnection www.google.com -InformationLevel &quot;Detailed&quot; | Out-File -FilePath C:\\SystemDiagnosticCollection\\pingtoGoogle-FQDN.txt  Time stamped ping​ Test-NetConnection &lt;#The Command below relies on there being a folder created before running the command, use the command below to do this if needed.#&gt; New-Item &quot;C:\\SystemDiagnosticCollection&quot; -itemType Directory # Creates the folder and the desired path. Write-host 'Folder created at C:\\SystemDiagnosticCollection' # Add this if you're writing a script where you need to update the PowerShell prompt. # Time Stamped Ping test Test-connection 8.8.8.8 -count 10 | format-table -AutoSize @{n='TimeStamp';e={Get-Date}},__SERVER, Address, ProtocolAddress, ResponseTime | Out-File -FilePath C:\\SystemDiagnosticCollection\\PingtoGoogle-IP.txt Write-host 'Network Tests ran successfully' # Add this if you're writing a script where you need to update the PowerShell prompt.  "},{"title":"Collecting Event Logs​","type":1,"pageTitle":"PowerShell","url":"/Command Line References/PowerShell#collecting-event-logs","content":"Get-EventLog &lt;#The Command below relies on there being a folder created before running the command, use the command below to do this if needed.#&gt; New-Item &quot;C:\\SystemDiagnosticCollection&quot; -itemType Directory # Creates the folder and the desired path. Write-host 'Folder created at C:\\SystemDiagnosticCollection' # Add this if you're writing a script where you need to update the PowerShell prompt. # Collect System Logs Get-Eventlog -LogName System -EntryType Error,Warning -After (Get-Date).AddHours(-2) | Export-csv c:\\SystemDiagnosticCollection\\System_Logs.csv -notype # Collect Application Logs Get-Eventlog -LogName Application -EntryType Error,Warning -After (Get-Date).AddHours(-2) | Export-csv c:\\SystemDiagnosticCollection\\Application_Logs.csv -notype Write-host 'Successfully gathered Event Logs'  "},{"title":"Collect Printer information​","type":1,"pageTitle":"PowerShell","url":"/Command Line References/PowerShell#collect-printer-information","content":"Get-printer &lt;#The Command below relies on there being a folder created before running the command, use the command below to do this if needed.#&gt; New-Item &quot;C:\\SystemDiagnosticCollection&quot; -itemType Directory # Creates the folder and the desired path. Write-host 'Folder created at C:\\SystemDiagnosticCollection' # Add this if you're writing a script where you need to update the PowerShell prompt. # Collect printer information Get-printer | Out-File -FilePath C:\\SystemDiagnosticCollection\\Printer-Info.txt Write-host 'Gathered Printer info' # Add this if you're writing a script where you need to update the PowerShell prompt.  "},{"title":"Collect Group Policy Information​","type":1,"pageTitle":"PowerShell","url":"/Command Line References/PowerShell#collect-group-policy-information","content":"gpresult /v &lt;#The Command below relies on there being a folder created before running the command, use the command below to do this if needed.#&gt; New-Item &quot;C:\\SystemDiagnosticCollection&quot; -itemType Directory # Creates the folder and the desired path. Write-host 'Folder created at C:\\SystemDiagnosticCollection' # Add this if you're writing a script where you need to update the PowerShell prompt. # Collect printer information gpresult /v | Out-file -FilePath C:\\SystemDiagnosticCollection\\GpResult.txt Write-host 'Gathered GPO status' # Add this if you're writing a script where you need to update the PowerShell prompt.  "},{"title":"Collect Azure Active Directory​","type":1,"pageTitle":"PowerShell","url":"/Command Line References/PowerShell#collect-azure-active-directory","content":"dsregcmd dsregcmd This command is a command prompt command only. &lt;#The Command below relies on there being a folder created before running the command, use the command below to do this if needed.#&gt; New-Item &quot;C:\\SystemDiagnosticCollection&quot; -itemType Directory # Creates the folder and the desired path. Write-host 'Folder created at C:\\SystemDiagnosticCollection' # Add this if you're writing a script where you need to update the PowerShell prompt. # Collect printer information dsregcmd /status | Out-File -FilePath C:\\SystemDiagnosticCollection\\Hybrid-Joined-status.txt Write-host 'Successfully checked for Hybrid-Joined status' # Add this if you're writing a script where you need to update the PowerShell prompt.  Collect the 'key' info from dsregcmd command​ info This script could use a little tidying up but, it should give you an idea of what is needed.  New-Item &quot;C:\\SystemDiagnosticCollection&quot; -itemType Directory Write-host 'Folder created at C:\\SystemDiagnosticCollection' #not finished yet, it'll print out only. Write-host 'Basic AAD Info' dsregcmd /status | select-string -Pattern 'Device Name' | Out-File -FilePath C:\\SystemDiagnosticCollection\\Basic-AAD-Info.txt dsregcmd /status | select-string -Pattern 'AzureADJoined' | Out-File -Append -FilePath C:\\SystemDiagnosticCollection\\Basic-AAD-Info.txt dsregcmd /status | select-string -Pattern 'DeviceId' | Out-File -Append -FilePath C:\\SystemDiagnosticCollection\\Basic-AAD-Info.txt dsregcmd /status | select-string -Pattern 'TenantName' | Out-File -Append -FilePath C:\\SystemDiagnosticCollection\\Basic-AAD-Info.txt write-host 'Single Sign on Info' dsregcmd /status | select-string -Pattern 'AzureAdPrt' | Out-File -FilePath C:\\SystemDiagnosticCollection\\Single-Sign-on-Info.txt dsregcmd /status | select-string -Pattern 'AzureAdPrtUpdateTime' | Out-File -Append -FilePath C:\\SystemDiagnosticCollection\\Single-Sign-on-Info.txt dsregcmd /status | select-string -Pattern 'RefreshPrtDiagnostics' | Out-File -Append -FilePath C:\\SystemDiagnosticCollection\\Single-Sign-on-Info.txt Write-host 'System Information' systeminfo | Select-String -Pattern 'OS Name' | Out-File -FilePath C:\\SystemDiagnosticCollection\\System-Information.txt systeminfo | Select-String -Pattern 'OS Version' | Out-File -Append -FilePath C:\\SystemDiagnosticCollection\\System-Information.txt systeminfo | Select-String -Pattern 'Original Install Date' | Out-File -Append -FilePath C:\\SystemDiagnosticCollection\\System-Information.txt systeminfo | Select-String -Pattern 'System Boot Time' | Out-File -Append -FilePath C:\\SystemDiagnosticCollection\\System-Information.txt systeminfo | Select-String -Pattern 'Time Zone' | Out-File -Append -FilePath C:\\SystemDiagnosticCollection\\System-Information.txt systeminfo | Select-String -Pattern 'Total Physical Memory' | Out-File -Append -FilePath C:\\SystemDiagnosticCollection\\System-Information.txt  "}]