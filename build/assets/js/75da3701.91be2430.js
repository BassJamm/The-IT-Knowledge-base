"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[863],{3905:(t,e,r)=>{r.d(e,{Zo:()=>d,kt:()=>k});var n=r(7294);function a(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function l(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n)}return r}function i(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?l(Object(r),!0).forEach((function(e){a(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):l(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}function o(t,e){if(null==t)return{};var r,n,a=function(t,e){if(null==t)return{};var r,n,a={},l=Object.keys(t);for(n=0;n<l.length;n++)r=l[n],e.indexOf(r)>=0||(a[r]=t[r]);return a}(t,e);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(t);for(n=0;n<l.length;n++)r=l[n],e.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(t,r)&&(a[r]=t[r])}return a}var c=n.createContext({}),p=function(t){var e=n.useContext(c),r=e;return t&&(r="function"==typeof t?t(e):i(i({},e),t)),r},d=function(t){var e=p(t.components);return n.createElement(c.Provider,{value:e},t.children)},m="mdxType",s={inlineCode:"code",wrapper:function(t){var e=t.children;return n.createElement(n.Fragment,{},e)}},g=n.forwardRef((function(t,e){var r=t.components,a=t.mdxType,l=t.originalType,c=t.parentName,d=o(t,["components","mdxType","originalType","parentName"]),m=p(r),g=a,k=m["".concat(c,".").concat(g)]||m[g]||s[g]||l;return r?n.createElement(k,i(i({ref:e},d),{},{components:r})):n.createElement(k,i({ref:e},d))}));function k(t,e){var r=arguments,a=e&&e.mdxType;if("string"==typeof t||a){var l=r.length,i=new Array(l);i[0]=g;var o={};for(var c in e)hasOwnProperty.call(e,c)&&(o[c]=e[c]);o.originalType=t,o[m]="string"==typeof t?t:a,i[1]=o;for(var p=2;p<l;p++)i[p]=r[p];return n.createElement.apply(null,i)}return n.createElement.apply(null,r)}g.displayName="MDXCreateElement"},9209:(t,e,r)=>{r.r(e),r.d(e,{assets:()=>c,contentTitle:()=>i,default:()=>s,frontMatter:()=>l,metadata:()=>o,toc:()=>p});var n=r(7462),a=(r(7294),r(3905));const l={draft:!1,id:"Network Security Groups",title:"Network Security Groups",hide_title:!1,hide_table_of_contents:!1,sidebar_label:"Network Security Groups",sidebar_position:1,toc_max_heading_level:4,pagination_label:"Network Security Groups",tags:["Azure","Network Security Groups","Networking"],custom_edit_url:"https://github.com/facebook/docusaurus/edit/main/docs/api-doc-markdown.md",description:"Guidance for Network Security Groups."},i=void 0,o={unversionedId:"Azure/Networking/Network Security Groups",id:"Azure/Networking/Network Security Groups",title:"Network Security Groups",description:"Guidance for Network Security Groups.",source:"@site/docs/Azure/Networking/Network Security Groups.md",sourceDirName:"Azure/Networking",slug:"/Azure/Networking/Network Security Groups",permalink:"/Azure/Networking/Network Security Groups",draft:!1,editUrl:"https://github.com/facebook/docusaurus/edit/main/docs/api-doc-markdown.md",tags:[{label:"Azure",permalink:"/tags/azure"},{label:"Network Security Groups",permalink:"/tags/network-security-groups"},{label:"Networking",permalink:"/tags/networking"}],version:"current",sidebarPosition:1,frontMatter:{draft:!1,id:"Network Security Groups",title:"Network Security Groups",hide_title:!1,hide_table_of_contents:!1,sidebar_label:"Network Security Groups",sidebar_position:1,toc_max_heading_level:4,pagination_label:"Network Security Groups",tags:["Azure","Network Security Groups","Networking"],custom_edit_url:"https://github.com/facebook/docusaurus/edit/main/docs/api-doc-markdown.md",description:"Guidance for Network Security Groups."},sidebar:"tutorialSidebar",previous:{title:"Networking",permalink:"/category/networking"},next:{title:"Azure Active Directory",permalink:"/category/azure-active-directory"}},c={},p=[{value:"Document Control",id:"document-control",level:2},{value:"Rules and priority suggestions",id:"rules-and-priority-suggestions",level:2},{value:"Service Tags",id:"service-tags",level:3},{value:"Rule Priority",id:"rule-priority",level:3},{value:"Inbound Rule Suggestions",id:"inbound-rule-suggestions",level:3},{value:"Outbound Rule Suggestions",id:"outbound-rule-suggestions",level:3},{value:"NSG Flow Logs",id:"nsg-flow-logs",level:2},{value:"Common use cases",id:"common-use-cases",level:3},{value:"Network monitoring",id:"network-monitoring",level:3},{value:"Usage monitoring and optimization",id:"usage-monitoring-and-optimization",level:3},{value:"Compliance",id:"compliance",level:3},{value:"Reading the flow log",id:"reading-the-flow-log",level:3},{value:"Example flow log entry",id:"example-flow-log-entry",level:3},{value:"Flow Tuples",id:"flow-tuples",level:3},{value:"Script to read the logs via PowerShell",id:"script-to-read-the-logs-via-powershell",level:2}],d={toc:p},m="wrapper";function s(t){let{components:e,...l}=t;return(0,a.kt)(m,(0,n.Z)({},d,l,{components:e,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"document-control"},"Document Control"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Created: 23/04/23"),(0,a.kt)("li",{parentName:"ul"},"Last Updated: 23/04/23")),(0,a.kt)("h2",{id:"rules-and-priority-suggestions"},"Rules and priority suggestions"),(0,a.kt)("h3",{id:"service-tags"},"Service Tags"),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://learn.microsoft.com/en-us/azure/virtual-network/service-tags-overview"},"Virtual Network Service tags | Microsoft doc link")),(0,a.kt)("p",null,"A service tag represents a group of IP address prefixes from a given Azure service. Microsoft manages the address prefixes encompassed by the service tag and automatically updates the service tag as addresses change, minimizing the complexity of frequent updates to network security rules."),(0,a.kt)("h3",{id:"rule-priority"},"Rule Priority"),(0,a.kt)("p",null,"A number between 100 and 4096. Rules are processed in priority order, with lower numbers processed before higher numbers, because lower numbers have higher priority. Once traffic matches a rule, processing stops. As a result, any rules that exist with lower priorities (higher numbers) that have the same attributes as rules with higher priorities aren\u2019t processed."),(0,a.kt)("h3",{id:"inbound-rule-suggestions"},"Inbound Rule Suggestions"),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:"center"},"Priority"),(0,a.kt)("th",{parentName:"tr",align:"center"},"Name"),(0,a.kt)("th",{parentName:"tr",align:"center"},"Port"),(0,a.kt)("th",{parentName:"tr",align:"center"},"protocol"),(0,a.kt)("th",{parentName:"tr",align:"center"},"Source"),(0,a.kt)("th",{parentName:"tr",align:"center"},"Destination"),(0,a.kt)("th",{parentName:"tr",align:"center"},"Action"),(0,a.kt)("th",{parentName:"tr",align:"center"},"Notes"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"center"},"100 to 109"),(0,a.kt)("td",{parentName:"tr",align:"center"}),(0,a.kt)("td",{parentName:"tr",align:"center"}),(0,a.kt)("td",{parentName:"tr",align:"center"}),(0,a.kt)("td",{parentName:"tr",align:"center"}),(0,a.kt)("td",{parentName:"tr",align:"center"}),(0,a.kt)("td",{parentName:"tr",align:"center"}),(0,a.kt)("td",{parentName:"tr",align:"center"},"100 to 109 available for overrides")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"center"},"110 to 199"),(0,a.kt)("td",{parentName:"tr",align:"center"}),(0,a.kt)("td",{parentName:"tr",align:"center"}),(0,a.kt)("td",{parentName:"tr",align:"center"}),(0,a.kt)("td",{parentName:"tr",align:"center"}),(0,a.kt)("td",{parentName:"tr",align:"center"}),(0,a.kt)("td",{parentName:"tr",align:"center"}),(0,a.kt)("td",{parentName:"tr",align:"center"})),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"center"},"200"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Deny-Internet-to-Any"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Any"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Any"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Internet (Service tag)"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Any"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Deny"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Deny All inbound Internet access.")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"center"},"200 to 299"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow any internal vNet services"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow any internal vNet services")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"center"},"300"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Deny-From-VNET-to-VNET"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Any"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Any"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Any"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Any"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Deny"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"center"},"301 to 64999"),(0,a.kt)("td",{parentName:"tr",align:"center"},"For non-vnet or internet facing rules"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"For non-vnet or internet facing rules")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"center"},"65000"),(0,a.kt)("td",{parentName:"tr",align:"center"},"AllowVnetInBound"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Any"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Any"),(0,a.kt)("td",{parentName:"tr",align:"center"},"VirtualNetwork"),(0,a.kt)("td",{parentName:"tr",align:"center"},"VirtualNetwork"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Built in Rule")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"center"},"65000 to 65500"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Are built in rules"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Are built in rules")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"center"},"65001"),(0,a.kt)("td",{parentName:"tr",align:"center"},"AllowAzureLoadBalancerInBound"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Any"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Any"),(0,a.kt)("td",{parentName:"tr",align:"center"},"AzureLoadBalancer"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Any"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Built in Rule")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"center"},"65500"),(0,a.kt)("td",{parentName:"tr",align:"center"},"DenyAllInBound"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Any"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Any"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Any"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Any"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Deny"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Built in Rule")))),(0,a.kt)("h3",{id:"outbound-rule-suggestions"},"Outbound Rule Suggestions"),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:"center"},"Priority"),(0,a.kt)("th",{parentName:"tr",align:"center"},"Name"),(0,a.kt)("th",{parentName:"tr",align:"center"},"Port"),(0,a.kt)("th",{parentName:"tr",align:"center"},"protocol"),(0,a.kt)("th",{parentName:"tr",align:"center"},"Source"),(0,a.kt)("th",{parentName:"tr",align:"center"},"Destination"),(0,a.kt)("th",{parentName:"tr",align:"center"},"Action"),(0,a.kt)("th",{parentName:"tr",align:"center"},"Notes"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"center"},"100 to 109"),(0,a.kt)("td",{parentName:"tr",align:"center"},"100 to 109"),(0,a.kt)("td",{parentName:"tr",align:"center"},"available for overrides"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"100 to 109 available for overrides")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"center"},"110 to 199"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow any inbound internet services."),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow any inbound internet services.")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"center"},"111"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow http"),(0,a.kt)("td",{parentName:"tr",align:"center"},"80"),(0,a.kt)("td",{parentName:"tr",align:"center"},"TCP"),(0,a.kt)("td",{parentName:"tr",align:"center"},"0.0.0.0/24"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Internet (Service Tag)"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow http services to internet.")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"center"},"112"),(0,a.kt)("td",{parentName:"tr",align:"center"},"All https"),(0,a.kt)("td",{parentName:"tr",align:"center"},"443"),(0,a.kt)("td",{parentName:"tr",align:"center"},"TCP"),(0,a.kt)("td",{parentName:"tr",align:"center"},"0.0.0.0/24"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Internet (Service Tag)"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow https services to internet.")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"center"},"114"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow-DNS-to-MicrosoftAzure"),(0,a.kt)("td",{parentName:"tr",align:"center"},"53"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Any"),(0,a.kt)("td",{parentName:"tr",align:"center"},"0.0.0.0/24"),(0,a.kt)("td",{parentName:"tr",align:"center"},"168.63.129.16"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow DNS to Azure IP")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"center"},"115"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow-AADConnect-to-AzureAD"),(0,a.kt)("td",{parentName:"tr",align:"center"},"443,80"),(0,a.kt)("td",{parentName:"tr",align:"center"},"TCP"),(0,a.kt)("td",{parentName:"tr",align:"center"},"10.125.8.13"),(0,a.kt)("td",{parentName:"tr",align:"center"},"AzureAzureActiveDirectory (Service Tag)"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow Allow AAD Connect services.")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"center"},"116"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow-Azuresiterecovery"),(0,a.kt)("td",{parentName:"tr",align:"center"},"443,80"),(0,a.kt)("td",{parentName:"tr",align:"center"},"TCP"),(0,a.kt)("td",{parentName:"tr",align:"center"},"0.0.0.0/24"),(0,a.kt)("td",{parentName:"tr",align:"center"},"AzureSiteRecovery"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow Azure Site Recovery services.")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"center"},"117"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow-AzureKeyVault"),(0,a.kt)("td",{parentName:"tr",align:"center"},"443,80"),(0,a.kt)("td",{parentName:"tr",align:"center"},"TCP"),(0,a.kt)("td",{parentName:"tr",align:"center"},"0.0.0.0/24"),(0,a.kt)("td",{parentName:"tr",align:"center"},"AzureKeyVault"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow Azure Key Vault services. (Dependency for ASR).")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"center"},"118"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow-GuestAndHybridManagement"),(0,a.kt)("td",{parentName:"tr",align:"center"},"443,80"),(0,a.kt)("td",{parentName:"tr",align:"center"},"TCP"),(0,a.kt)("td",{parentName:"tr",align:"center"},"0.0.0.0/24"),(0,a.kt)("td",{parentName:"tr",align:"center"},"GuestAndHybridManagement"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow Guest and Hybrid Management services. (Dependency for ASR, AzMonitor).")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"center"},"119"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow-Storage"),(0,a.kt)("td",{parentName:"tr",align:"center"},"443,80"),(0,a.kt)("td",{parentName:"tr",align:"center"},"TCP"),(0,a.kt)("td",{parentName:"tr",align:"center"},"0.0.0.0/24"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Storage"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow Storage services. (Dependency for ASR, AzMonitor).")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"center"},"120"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow-EventHub"),(0,a.kt)("td",{parentName:"tr",align:"center"},"443,80"),(0,a.kt)("td",{parentName:"tr",align:"center"},"TCP"),(0,a.kt)("td",{parentName:"tr",align:"center"},"0.0.0.0/24"),(0,a.kt)("td",{parentName:"tr",align:"center"},"EventHub"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow Event Hub services. (Dependency for ASR).")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"center"},"121"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow-AzureMonitor"),(0,a.kt)("td",{parentName:"tr",align:"center"},"443,80"),(0,a.kt)("td",{parentName:"tr",align:"center"},"TCP"),(0,a.kt)("td",{parentName:"tr",align:"center"},"0.0.0.0/24"),(0,a.kt)("td",{parentName:"tr",align:"center"},"AzureMonitor"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow Event Hub services. (Dependency for ASR).")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"center"},"122"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow-WindowsUpdate-AzUpdateDeliver"),(0,a.kt)("td",{parentName:"tr",align:"center"},"443,80"),(0,a.kt)("td",{parentName:"tr",align:"center"},"TCP"),(0,a.kt)("td",{parentName:"tr",align:"center"},"0.0.0.0/24"),(0,a.kt)("td",{parentName:"tr",align:"center"},"AzureUpdateDelivery (Service Tag)"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow Az update delivery services")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"center"},"123"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow-WindowsUpdate-AzFrontDoorFP"),(0,a.kt)("td",{parentName:"tr",align:"center"},"443,80"),(0,a.kt)("td",{parentName:"tr",align:"center"},"TCP"),(0,a.kt)("td",{parentName:"tr",align:"center"},"0.0.0.0/24"),(0,a.kt)("td",{parentName:"tr",align:"center"},"AzureFrontDoor.FirstParty (Service Tag)"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow Az update delivery services")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"center"},"200"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Deny-Internet-to-Any"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Any"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Any"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Internet (Service tag)"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Any"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Deny"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Deny All inbound Internet access.")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"center"},"200 to 299"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow any internal vNet services"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow any internal vNet services")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"center"},"300"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Deny-From-VNET-to-VNET"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Any"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Any"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Any"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Any"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Deny"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"center"},"301 to 64999"),(0,a.kt)("td",{parentName:"tr",align:"center"},"For non-vnet or internet facing rules"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"For non-vnet or internet facing rules")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"center"},"65000"),(0,a.kt)("td",{parentName:"tr",align:"center"},"AllowVnetInBound"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Any"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Any"),(0,a.kt)("td",{parentName:"tr",align:"center"},"VirtualNetwork"),(0,a.kt)("td",{parentName:"tr",align:"center"},"VirtualNetwork"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Allow Built in Rule"),(0,a.kt)("td",{parentName:"tr",align:"center"})),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"center"},"65000 to 65500"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Are built in rules"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"-"),(0,a.kt)("td",{parentName:"tr",align:"center"},"Are built in rules")))),(0,a.kt)("h2",{id:"nsg-flow-logs"},"NSG Flow Logs"),(0,a.kt)("p",null,"NSG flow logs is a feature of Azure Network Watcher that allows you to log information about IP traffic flowing through a network security group (NSG). Flow data is sent to Azure Storage from where you can access it and export it to any visualization tool."),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://learn.microsoft.com/en-us/azure/network-watcher/network-watcher-nsg-flow-logging-overview"},"Flow logs for network security groups | Microsoft doc link")),(0,a.kt)("h3",{id:"common-use-cases"},"Common use cases"),(0,a.kt)("admonition",{title:"Sources",type:"note"},(0,a.kt)("p",{parentName:"admonition"},"All of the below information has been ripped out of a Microsoft doc, not my original material.")),(0,a.kt)("h3",{id:"network-monitoring"},"Network monitoring"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Identify unknown or undesired traffic."),(0,a.kt)("li",{parentName:"ul"},"Monitor traffic levels and bandwidth consumption."),(0,a.kt)("li",{parentName:"ul"},"Filter flow logs by IP and port to understand application behavior."),(0,a.kt)("li",{parentName:"ul"},"Export flow logs to analytics and visualization tools of your choice to set up monitoring dashboards.")),(0,a.kt)("h3",{id:"usage-monitoring-and-optimization"},"Usage monitoring and optimization"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Identify top talkers in your network."),(0,a.kt)("li",{parentName:"ul"},"Combine with GeoIP data to identify cross-region traffic."),(0,a.kt)("li",{parentName:"ul"},"Understand traffic growth for capacity forecasting."),(0,a.kt)("li",{parentName:"ul"},"Use data to remove overly restrictive traffic rules.")),(0,a.kt)("h3",{id:"compliance"},"Compliance"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Use flow data to verify network isolation and compliance with enterprise access rules."),(0,a.kt)("li",{parentName:"ul"},"Network forensics and security analysis"),(0,a.kt)("li",{parentName:"ul"},"Analyze network flows from compromised IPs and network interfaces."),(0,a.kt)("li",{parentName:"ul"},"Export flow logs to any SIEM or IDS tool of your choice.")),(0,a.kt)("h3",{id:"reading-the-flow-log"},"Reading the flow log"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Logs are in JSON format and will be outputting in the json file format."),(0,a.kt)("li",{parentName:"ul"},"The information that is interesting is in the flowtuples section of the json file.")),(0,a.kt)("h3",{id:"example-flow-log-entry"},"Example flow log entry"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json",metastring:"showLineNumbers",showLineNumbers:!0},'{\n    "records": [\n        {\n            "time": "2018-11-13T12:00:35.3899262Z",\n            "systemId": "a0fca5ce-022c-47b1-9735-89943b42f2fa",\n            "category": "NetworkSecurityGroupFlowEvent",\n            "resourceId": "/SUBSCRIPTIONS/00000000-0000-0000-0000-000000000000/RESOURCEGROUPS/FABRIKAMRG/PROVIDERS/MICROSOFT.NETWORK/NETWORKSECURITYGROUPS/FABRIAKMVM1-NSG",\n            "operationName": "NetworkSecurityGroupFlowEvents",\n            "properties": {\n                "Version": 2,\n                "flows": [\n                    {\n                        "rule": "DefaultRule_DenyAllInBound",\n                        "flows": [\n                            {\n                                "mac": "000D3AF87856",\n                                "flowTuples": [\n                                    "1542110402,94.102.49.190,10.5.16.4,28746,443,U,I,D,B,,,,",\n                                    "1542110424,176.119.4.10,10.5.16.4,56509,59336,T,I,D,B,,,,",\n                                    "1542110432,167.99.86.8,10.5.16.4,48495,8088,T,I,D,B,,,,"\n                                ]\n                            }\n                        ]\n                    },\n                    {\n                        "rule": "DefaultRule_AllowInternetOutBound",\n                        "flows": [\n                            {\n                                "mac": "000D3AF87856",\n                                "flowTuples": [\n                                    "1542110377,10.5.16.4,13.67.143.118,59831,443,T,O,A,B,,,,",\n                                    "1542110379,10.5.16.4,13.67.143.117,59932,443,T,O,A,E,1,66,1,66",\n                                    "1542110379,10.5.16.4,13.67.143.115,44931,443,T,O,A,C,30,16978,24,14008",\n                                    "1542110406,10.5.16.4,40.71.12.225,59929,443,T,O,A,E,15,8489,12,7054"\n                                ]\n                            }\n                        ]\n                    }\n                ]\n            }\n        },\n        {\n            "time": "2018-11-13T12:01:35.3918317Z",\n            "systemId": "a0fca5ce-022c-47b1-9735-89943b42f2fa",\n            "category": "NetworkSecurityGroupFlowEvent",\n            "resourceId": "/SUBSCRIPTIONS/00000000-0000-0000-0000-000000000000/RESOURCEGROUPS/FABRIKAMRG/PROVIDERS/MICROSOFT.NETWORK/NETWORKSECURITYGROUPS/FABRIAKMVM1-NSG",\n            "operationName": "NetworkSecurityGroupFlowEvents",\n            "properties": {\n                "Version": 2,\n                "flows": [\n                    {\n                        "rule": "DefaultRule_DenyAllInBound",\n                        "flows": [\n                            {\n                                "mac": "000D3AF87856",\n                                "flowTuples": [\n                                    "1542110437,125.64.94.197,10.5.16.4,59752,18264,T,I,D,B,,,,",\n                                    "1542110475,80.211.72.221,10.5.16.4,37433,8088,T,I,D,B,,,,",\n                                    "1542110487,46.101.199.124,10.5.16.4,60577,8088,T,I,D,B,,,,",\n                                    "1542110490,176.119.4.30,10.5.16.4,57067,52801,T,I,D,B,,,,"\n                                ]\n                            }\n                        ]\n                    }\n                ]\n            }\n        }\n')),(0,a.kt)("h3",{id:"flow-tuples"},"Flow Tuples"),(0,a.kt)("p",null,"flowTuples: String that contains multiple properties for the flow tuple in a comma-separated format"),(0,a.kt)("p",null,"Example entry: 1493695838,185.170.185.105,10.2.0.4,35370,23,T,I,A,C,1021,588096,8005,4610880"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Flowtupleimage",src:r(1564).Z,width:"1200",height:"250"})),(0,a.kt)("h2",{id:"script-to-read-the-logs-via-powershell"},"Script to read the logs via PowerShell"),(0,a.kt)("p",null,"Dump the below into a file as a script (.ps1) filetype."),(0,a.kt)("p",null,"To use the script below, navigate to the location of the file, and use the NsgFlowLogFileName switch to select the JSON file."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-powershell",metastring:"showLineNumbers",showLineNumbers:!0},"cd C:\\Temp\\\n.\\Parse-NSG-FlowLog_json.ps1 -NsgFlowLogFileName .\\PT1H.json | ft -AutoSize\n")),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"I didn't write this script, I cannot take any credit for it!")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-powershell",metastring:"showLineNumbers",showLineNumbers:!0},'param(\n    [string]$NsgFlowLogFileName = "C:\\Temp\\filename.json"\n)\n \n# Import the logs from the file convert it from json into a powershell object\n$logs = gc $NsgFlowLogFileName  -ErrorAction SilentlyContinue | ConvertFrom-Json | select -ExpandProperty records\n \n# Loop through each entry in the json file\nforeach ($Log in $Logs)\n    {\n    #Get a list of flows\n    $Flows = $log.properties.flows\n \n    # Loop through each flow of each json entry and output the details\n    foreach ($Flow in $Flows)\n        {\n        # Split the flow information to a variable for easier and quicker referencing\n        $FlowInfo = $Flow.flows.flowtuples[0] -split(\',\')\n \n        # Output details as a powershell object\n        [pscustomobject]@{\n            DateTime      = (Get-Date 01.01.1970)+([System.TimeSpan]::fromseconds($FlowInfo[0]))    # Converts time format.\n            NSGName       = $Log.resourceId.split(\'/\')[-1]\n            RuleName      = $Flow.rule\n            Decision      = switch ($FlowInfo[7]) { \'a\' { "Allowed" } ; "d" {"Denied"} }\n            FlowState     = switch ($FlowInfo[8]) { \'B\' { "Begin" } ; "C" {"Continue"} ; "e" {"End"} }\n            SourceIP      = $FlowInfo[1]\n            SourcePort    = $FlowInfo[3]\n            DestIP        = $FlowInfo[2]\n            DestPort      = $FlowInfo[4]\n            Protocol      = switch ($FlowInfo[5]) { \'t\' { "TCP" } ; "u" {"UDP"} }\n            Direction     = switch ($FlowInfo[6]) { \'i\' { "InBound" } ; "o" {"OutBound"} }\n            SourcePackets = $FlowInfo[9]\n            SourceBytes   = $FlowInfo[10]\n            DestPackets   = $FlowInfo[11]\n            DestBytes     = $FlowInfo[12]\n \n            # Below line ends the flow loop, then filters out the empty entries.\n            } | where SourceIP -ne $null\n      }\n    }\n')))}s.isMDXComponent=!0},1564:(t,e,r)=>{r.d(e,{Z:()=>n});const n=r.p+"assets/images/flowtuple-c88fb0e77b04e6125803fe68919daa26.png"}}]);